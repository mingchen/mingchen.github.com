
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ming's Blog</title>
  <meta name="author" content="Ming">

  
  <meta name="description" content="在终端中Ctrl+L或者clear会重绘屏幕。
它能清除由系统广播消息导致的屏幕混乱情况。
但如果是由于屏幕上打印了一些控制字符引起的屏幕混乱，
Ctrl+L就没有效果了，这个时候需要使用reset命令。 There is garbage on the screen, or all your &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.chenming.info/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Ming's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-33056683-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ming's Blog</a></h1>
  
    <h2>trivial notes</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.chenming.info" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories">Categories</a></li>
  <li><a href="/blog/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/22/linux-reset-terminal/">在Linux下清屏是clear还是reset</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-22T19:21:00-08:00" pubdate data-updated="true">Dec 22<span>nd</span>, 2011</time>
        
         | <a href="/blog/2011/12/22/linux-reset-terminal/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在终端中<code>Ctrl+L</code>或者<code>clear</code>会重绘屏幕。
它能清除由系统广播消息导致的屏幕混乱情况。
但如果是由于屏幕上打印了一些控制字符引起的屏幕混乱，
<code>Ctrl+L</code>就没有效果了，这个时候需要使用<code>reset</code>命令。</p>

<blockquote><p>There is garbage on the screen, or all your keystrokes are echoed as line drawing characters. What to do?</p><p>Many programs will redraw the screen when `Ctrl-L` is typed. This might help when there is some modem noise or broadcast<br/>message on your screen. The command `clear` will clear the screen.</p><p>The command `reset` will reset the console driver. This helps when the screen is full of funny graphic characters, and<br/>also if it is reduced to the bottom line.</p><footer><strong>Resetting your terminal</strong> <cite><a href='http://tldp.org/HOWTO/Keyboard-and-Console-HOWTO-4.html'>Linux Howto</a></cite></footer></blockquote>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/20/cookie-expries-issue-on-django-auth/">服务器时间不正确导致django的认证失败</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-12-20T08:20:00-08:00" pubdate data-updated="true">Dec 20<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/12/20/cookie-expries-issue-on-django-auth/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>平时跑的好好的django系统，突然发现IE登录后可以访问第一个页面，
而再继续访问其它页面的时候就出现认证失败，而Firefox是没有问题的。
django的认证是借助cookie来实现的。</p>

<p>经过对IE的抓包分析发现在后续的请求没有携带Cookie，
而在仔细看之前的http请求和响应，发现登录时服务器返回的Set-Cookie的超时时间是去年的时间，这就导致了IE认为这个Cookie已经过期，在后续的请求中就没有把这个Cookie带上，导致了认证的失败。再到服务器上看，服务器的时间居然被人改成去年的时间了。</p>

<p>解决方法很简单了，就是把服务器的时间修改正确。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/12/04/how-to-use-nettl-on-hpux/">在HP-UX上使用nettl抓包</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-12-04T10:16:00-08:00" pubdate data-updated="true">Dec 4<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/12/04/how-to-use-nettl-on-hpux/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>HP-UX 自己提供了抓包工具<code>nettl</code> 。
在<code>tcpdump</code>不能用的时候它（比如<code>tcpdump</code>在HP-UX上就不能抓回环上的包）就派上用场了。</p>

<p>总结一下<code>nettl</code>的主要用法，备查。</p>

<h2>开始抓包</h2>

<p>使用<code>nettl -tn</code>开始抓包，下面是一些常用的命令：</p>

<pre><code># nettl -tn all -e all -maxtrace 99999 -f /tmp/tx
# nettl -tn loopback -e ns_ls_tcp -maxtrace 99999 -f /tmp/tx
# nettl -tn pduin pduout -e ns_ls_loopback -tm 100000 -f /tmp/local
# nettl -tn pduin pduout -e ns_ls_loopback -m 56 -tm 100000 -f /tmp/local
# nettl -tn pduin -e ns_ls_loopback -m 56 -tm 100000 -f /tmp/local
</code></pre>

<p>-m size 限制每个包的大小。我们不一定对所有的包都感兴趣，在只对包头干兴趣的时候这个选项就非常有效。
比如某协议使用的包头为16个字节，再加上IP头的20个字节，TCP头的20个字节，
也就是我们只需要总共56个字节就能确定一个包的基本信息了。</p>

<p>-e subsytem 要抓包的类型，可以使用<code>nettl -status</code>来获取。</p>

<pre><code>ns_ls_loopback
ns_ls_ip
ns_ls_tcp
ns_ls_udp
ns_ls_icmp
</code></pre>

<p>-tm maxsize 每个文件的最大大小，如果超过此大小，会使用下一个抓包文件。
单位：KB。有效值：100~99999</p>

<p>抓包的输出文件为 <code>/tmp/tx.xxxx</code>，使用<code>ls -l /tmp/tx.*</code>来检查</p>

<p>说明：</p>

<p>在<code>ns_ls_loopback</code>上抓包如果指定了<code>pduin</code>和<code>pduout</code>每个包会抓到2份，因为一进一出就是两份。
如果指定<code>-tn all -e all</code>一个包也会抓到多份，因为一个包可能属于不同的<code>subsystem</code>，
比如一个<code>tcp</code>包既属于<code>tcp</code>，也属于<code>ip</code>等。</p>

<p>抓的包可以使用<code>wireshark</code>来直接打开并进行分析。也可以使用HP-UX自带的<code>netfmt</code>来分析。</p>

<p>查看状态及<code>-entity</code>可用的信息：</p>

<pre><code># nettl -status
</code></pre>

<h2>停止抓包</h2>

<p>使用<code>nettl -tf</code>来停止抓包。</p>

<pre><code># nettl -tf -e all
</code></pre>

<h2>对包的分析</h2>

<p>我们可以使用netfmt来查看捕获的包：</p>

<pre><code>netfmt -N -l -f /tmp/nettl_t* | more
</code></pre>

<p>可以过滤我们感兴趣的包，使用<code>-c</code>来传入过滤文件</p>

<pre><code>netfmt -N -l -c filter -f /tmp/nettl_t* | more
</code></pre>

<p>filter 为过滤文件，文件内容的类似如下：</p>

<pre><code>filter tcp_sport 1234
filter tcp_dport 1234
</code></pre>

<p>每一行为一个过滤条件，行与行之间是或的关系。</p>

<p>使用行模式来显示（这种模式下不会看到包的具体数据）</p>

<pre><code>netfmt -N -n -l -1 -f /tmp/nettl_t* | more
</code></pre>

<p>在每行的显示前加上时间戳</p>

<pre><code>netfmt -T -n -l -1 -f /tmp/nettl_t* | more
</code></pre>

<p>参考：</p>

<ul>
<li><a href="http://www.compute-aid.com/nettl.html">http://www.compute-aid.com/nettl.html</a></li>
<li><a href="http://docs.hp.com/en/B2355-60105/nettl.1M.html">http://docs.hp.com/en/B2355-60105/nettl.1M.html</a></li>
<li><a href="http://docs.hp.com/en/B2355-60105/netfmt.1M.html">http://docs.hp.com/en/B2355-60105/netfmt.1M.html</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/11/08/using-hill-climbing-algorithm-to-solve-n-queues-problem/">N皇后问题 - 使用随机爬山法实现其快速解法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-11-08T10:11:00-08:00" pubdate data-updated="true">Nov 8<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/11/08/using-hill-climbing-algorithm-to-solve-n-queues-problem/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>N皇后问题是一个经典的问题，在很多地方都有讨论过。
回溯法是经典的解法，但是随着N的增大，其复杂度的增加呈指数增长，
如果N=100使用回溯解法的话，回溯要运行的时间估计你可以去喝一壶茶了。</p>

<p>这段时间在看《人工智能》，里面也有对其的讨论，介绍了爬山法在N皇后问题中的应用。
爬山法是一种向值增加的方向持续移动到简单循环过程，它将会在到达一个“峰顶”时终止，
此时相邻状态中没有比该它更高的值。这个算法不维护搜索树。</p>

<p>最基本的爬上搜索算法(节选自《人工智能》第二版)：</p>

<figure class='code'><figcaption><span>随机爬山算法 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function HILL-CLIMBING(problem) return a state thate is a locak maximum
</span><span class='line'>    inputs: problem
</span><span class='line'>    local variables: current, a node
</span><span class='line'>                         neighbor,a node
</span><span class='line'>    current = MakeNode(INITAL-STATE(problem));
</span><span class='line'>    loop do
</span><span class='line'>        neighbor = a highest-valued successor of current ;
</span><span class='line'>        if VALUE[neighbor] &lt;= VALUE[current] then return STATE[current];
</span><span class='line'>        current = neighbor ;</span></code></pre></td></tr></table></div></figure>


<p>爬山法属于一种局部的贪婪搜索方法，当它在搜索过程中遇到了局部最大值就很难继续向下搜索了。因此产生了爬山法的变种如随机爬山法及其变种如随机爬山法，随机重新开始的爬山法，
模拟退火搜索能够非常有效的解决N皇后问题。</p>

<p>结合实际，我使用了随机爬山法的一个测试程序，不试不知道，测试发现速度果然是非常的快，
对于100皇后都是瞬间秒杀。不过这个程序要实现百万皇后的问题秒杀，估计还是一项很艰巨的工作。
不过随机爬山法这种方法是一种很有效的解决复杂搜索问题的方法之一。</p>

<p>程序如下，供以后参考：</p>

<figure class='code'><figcaption><span>使用随机爬山法解决N皇后问题 </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iterator&gt;</span>
</span><span class='line'><span class="cp">#include &lt;vector&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">CollisionList_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">print_row_mark</span><span class="p">(</span><span class="kt">int</span> <span class="n">N</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;+---&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;+&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">print_row</span><span class="p">(</span><span class="kt">int</span> <span class="n">N</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fill</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;| &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">i</span><span class="o">==</span><span class="n">fill</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;X&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;|&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">print_row_mark</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 皇后位置的表示方法:</span>
</span><span class='line'><span class="c1">// 使用数组chessman[N]来表示N个皇后的位置</span>
</span><span class='line'><span class="c1">// 第i个皇后chessman[i]的下标i表示其行所在的位置，</span>
</span><span class='line'><span class="c1">// chessman[i]表示其列的位置。</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// 一个四皇后问题的表示方法如下所示：</span>
</span><span class='line'><span class="c1">// (0, 1) (1, 3) (2, 0) (3, 2)</span>
</span><span class='line'><span class="c1">// +---+---+---+---+</span>
</span><span class='line'><span class="c1">// |   | X |   |   |</span>
</span><span class='line'><span class="c1">// +---+---+---+---+</span>
</span><span class='line'><span class="c1">// |   |   |   | X |</span>
</span><span class='line'><span class="c1">// +---+---+---+---+</span>
</span><span class='line'><span class="c1">// | X |   |   |   |</span>
</span><span class='line'><span class="c1">// +---+---+---+---+</span>
</span><span class='line'><span class="c1">// |   |   | X |   |</span>
</span><span class='line'><span class="c1">// +---+---+---+---+</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="kt">void</span> <span class="n">print_chessboard</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">chessman</span><span class="p">,</span> <span class="kt">int</span> <span class="n">N</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">chessman</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;) &quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">print_row_mark</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">print_row</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">chessman</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 随机生成一个初始化状态，在每行每列上放置一个皇后</span>
</span><span class='line'><span class="kt">void</span> <span class="n">generate_init_state</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">chessman</span><span class="p">,</span> <span class="kt">int</span> <span class="n">N</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">chessman</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
</span><span class='line'>    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">chessman</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">chessman</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 返回冲突的皇后个数</span>
</span><span class='line'><span class="kt">int</span> <span class="n">h</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">chessman</span><span class="p">,</span> <span class="kt">int</span> <span class="n">N</span><span class="p">,</span> <span class="n">CollisionList_t</span><span class="o">&amp;</span> <span class="n">collision_list</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">collision_list</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">int</span> <span class="n">collision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">row</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">row</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">((</span><span class="n">chessman</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">==</span> <span class="n">chessman</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
</span><span class='line'>          <span class="o">||</span> <span class="p">(</span><span class="n">chessman</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">==</span> <span class="n">chessman</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">row</span> <span class="o">-</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">collision_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
</span><span class='line'>        <span class="o">++</span><span class="n">collision</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">collision</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 如果交换后冲突不比原来的大，就进行交换</span>
</span><span class='line'><span class="c1">// 只有交换成功后才改变cl为新的冲突列表</span>
</span><span class='line'><span class="kt">int</span> <span class="n">try_exchange</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">chessman</span><span class="p">,</span> <span class="kt">int</span> <span class="n">N</span><span class="p">,</span> <span class="kt">int</span> <span class="n">row1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">row2</span><span class="p">,</span> <span class="n">CollisionList_t</span><span class="o">&amp;</span> <span class="n">cl</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">CollisionList_t</span> <span class="n">new_cl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 交换两行的皇后的位置</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">chessman</span><span class="p">[</span><span class="n">row1</span><span class="p">],</span> <span class="n">chessman</span><span class="p">[</span><span class="n">row2</span><span class="p">]);</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">new_collision</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">chessman</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">new_cl</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">new_collision</span> <span class="o">&gt;</span> <span class="n">cl</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 取消之前的交换</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">chessman</span><span class="p">[</span><span class="n">row1</span><span class="p">],</span> <span class="n">chessman</span><span class="p">[</span><span class="n">row2</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">cl</span> <span class="o">=</span> <span class="n">new_cl</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">new_cl</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">choose_next_state</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">chessman</span><span class="p">,</span> <span class="kt">int</span> <span class="n">N</span><span class="p">,</span> <span class="n">CollisionList_t</span><span class="o">&amp;</span> <span class="n">cl</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">old_collision</span> <span class="o">=</span> <span class="n">cl</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">new_collision</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">int</span> <span class="n">row1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">row2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// 优化最后只有一个冲突的解</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">cl</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">try_exchange</span><span class="p">(</span><span class="n">chessman</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 最后的选择，随机的选择两个皇后调换其位置</span>
</span><span class='line'>    <span class="n">row1</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
</span><span class='line'>    <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">row2</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">N</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">row1</span> <span class="o">==</span> <span class="n">row2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">new_collision</span> <span class="o">=</span> <span class="n">try_exchange</span><span class="p">(</span><span class="n">chessman</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">row1</span><span class="p">,</span> <span class="n">row2</span><span class="p">,</span> <span class="n">cl</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">new_collision</span> <span class="o">&gt;</span> <span class="n">old_collision</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">new_collision</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 使用随机爬山法寻找一个N皇后问题的解</span>
</span><span class='line'><span class="kt">int</span> <span class="n">queue_solution</span><span class="p">(</span><span class="kt">int</span> <span class="n">N</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span><span class="o">*</span> <span class="n">chessman</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">max_tries</span> <span class="o">=</span> <span class="n">N</span><span class="o">*</span><span class="n">N</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">max_steps</span> <span class="o">=</span> <span class="n">N</span><span class="o">*</span><span class="n">N</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&lt;</span> <span class="n">max_tries</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="o">++</span><span class="n">tries</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">int</span> <span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">collision</span><span class="p">;</span>
</span><span class='line'>      <span class="n">CollisionList_t</span> <span class="n">collision_list</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">+</span> <span class="n">tries</span> <span class="o">*</span> <span class="n">collision</span><span class="p">);</span>
</span><span class='line'>      <span class="n">generate_init_state</span><span class="p">(</span><span class="n">chessman</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
</span><span class='line'>      <span class="n">collision</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">chessman</span><span class="p">,</span>  <span class="n">N</span><span class="p">,</span> <span class="n">collision_list</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">while</span> <span class="p">((</span><span class="n">collision</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">steps</span><span class="o">&lt;</span><span class="n">max_steps</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">collision</span> <span class="o">=</span> <span class="n">choose_next_state</span><span class="p">(</span><span class="n">chessman</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">collision_list</span><span class="p">);</span>
</span><span class='line'>        <span class="o">++</span><span class="n">steps</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">collision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Found a solution. Tries: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tries</span>
</span><span class='line'>            <span class="o">&lt;&lt;</span> <span class="s">&quot; Steps: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">steps</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>          <span class="n">print_chessboard</span><span class="p">(</span><span class="n">chessman</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 接受一个命令行参数，要求为整数N，表示要寻找的解是N皇后问题。</span>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>    <span class="c1">// 缺省为寻找8皇后问题的一个解</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">N</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;N: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">N</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Input error: parameter must be a postive integer&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">queue_solution</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed, please try re-run to get a solution.&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>TODO：在选择下一步的时候还有改进空间，比如优先从冲突的皇后中随机选择皇后进行下一次的位置调换等。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/11/06/write-secure-code/">编写安全的代码 Secure Coding</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-11-06T09:57:00-08:00" pubdate data-updated="true">Nov 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/11/06/write-secure-code/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>今天又看了一下了安全编程的指南。看到对异常的处理部分，不由想到前两天在客户的环境中出现一个问题，
由于在捕获异常后没有完全释放之前获得锁，导致在程序出现异常后，某些资源一直处于被锁定状态。
最后只有重新启动应用才能释放资源。对异常的处理要非常的小心才是。</p>

<p>编写安全的代码的参考资料：</p>

<ul>
<li><p>[CERTSecCod] – CERT Secure Coding Standards
  <a href="https://www.securecoding.cert.org/confluence/display/seccode/CERT+Secure+Coding+Standards">https://www.securecoding.cert.org/confluence/display/seccode/CERT+Secure+Coding+Standards</a></p></li>
<li><p><a href="http://www.owasp.org/">http://www.owasp.org/</a> - Web Applications</p></li>
<li><p>[Posix] – The Open Group Base Specifications Issue 7, IEEE Std 1003.1-2008
  <a href="http://www.opengroup.org/onlinepubs/9699919799/nframe.html">http://www.opengroup.org/onlinepubs/9699919799/nframe.html</a></p></li>
<li><p>[STRLCPY] – strlcpy and strlcat&#8211;Consistent, Safe, String Copy and Concatenation
  <a href="http://www.usenix.org/events/usenix99/millert.html">http://www.usenix.org/events/usenix99/millert.html</a></p></li>
<li><p>[CppStdLib] – C++ Library Reference
  <a href="http://www.cplusplus.com/reference/">http://www.cplusplus.com/reference/</a></p></li>
</ul>


<p>Books:</p>

<ul>
<li>“The CERT C Secure Coding Standard”, Robert C. Seacord, Addison-Wesley Professional, 2008, ISBN-10: 0321563212, ISBN-13: 978-0321563217</li>
<li>“Secure Coding in C and C++”, Robert C. Seacord, Addison-Wesley Professional, 2005, ISBN-10: 0321335724, ISBN-13: 978-0321335722</li>
</ul>


<p>Papers:</p>

<ul>
<li>ISO/IEC PDTR 24772, Information technology – Programming languages – Guidelines to avoiding vulnerabilities in language selection and use
<a href="http://isotc.iso.org/livelink/livelink/SC22-N-4420.pdf?func=doc.Fetch&amp;nodeId=7716670&amp;docTitle=SC22-N-4420">http://isotc.iso.org/livelink/livelink/SC22-N-4420.pdf?func=doc.Fetch&amp;nodeId=7716670&amp;docTitle=SC22-N-4420</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/10/24/the-2nd-chengdu-scrum-assemble/">The 2nd Chengdu Scrum Assemble</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-10-24T09:50:00-07:00" pubdate data-updated="true">Oct 24<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/10/24/the-2nd-chengdu-scrum-assemble/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>今天参加了第二次的成都Scrum聚会，听到了一些新的Agile工具，在此列出以作备忘：</p>

<ul>
<li>Hudson，持续集成的工具。CruiseControl并不是唯一的选择。</li>
<li>NetBean，Eclipse的竞争者。</li>
<li>Mercurial，一个分布式的版本控制工具</li>
<li>xUnit</li>
<li>Sonar</li>
<li>Review Board</li>
<li>Maven</li>
<li>&#8230;</li>
</ul>


<p>大家有很多共识，软件开发中最关键的还是人。我认为软件开发需要做到的是 选择正确的人做正确的事。</p>

<blockquote><p>It all about people。</p></blockquote>


<p>关于<code>Self organization</code>，是有一个boundary的，
还记得ScrumMaster培训的时候那个小游戏在地上画的线吗？</p>

<p>在会上的抽奖节目中还有幸抽到了一本Scrum的书（虽然我看过它的英文版），也对组织者表示一下感谢。</p>

<p>我们的讨论组：<a href="http://groups.google.com/group/scrumcd">http://groups.google.com/group/scrumcd</a></p>

<p><a href="http://groups.google.com/group/scrumcd/browse_thread/thread/9f61abd1b9137125?hl=en">Presentation material from Agile Tour 2009 Chengdu</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/10/15/http-digest-auth-with-python/">使用Python实现HTTP的digest认证算法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-10-15T09:39:00-07:00" pubdate data-updated="true">Oct 15<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/10/15/http-digest-auth-with-python/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>因为测试需要，使用Python实现的的一个HTTP的digest认证算法。</p>

<p>关于HTTP的digest算法参考
<a href="http://www.ietf.org/rfc/rfc2617.txt">RFC 2617 - HTTP Authentication: Basic and Digest Access Authentication</a></p>

<p>代码如下：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Author: Chen Ming</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># HTTP authentication: RFC 2671</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">hashlib</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">H</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>  <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
</span><span class='line'>  <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">KD</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">H</span><span class="p">(</span><span class="n">secret</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c">#def auth_response(method, realm, username, password, uri, algorithm, nonce,</span>
</span><span class='line'><span class="c">#                  qop=&quot;&quot;, nc=&quot;&quot;, cnonce=&quot;&quot;, entity_body=&quot;&quot;):</span>
</span><span class='line'><span class="k">def</span> <span class="nf">auth_response</span><span class="p">(</span><span class="n">authinfo</span><span class="p">):</span>
</span><span class='line'>  <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    method should be &#39;REGISTER&#39;</span>
</span><span class='line'><span class="sd">    realm should be &#39;PoC Service C1.0&#39;</span>
</span><span class='line'><span class="sd">  &quot;&quot;&quot;</span>
</span><span class='line'>  <span class="n">method</span> <span class="o">=</span> <span class="s">&#39;REGISTER&#39;</span>
</span><span class='line'>  <span class="n">username</span> <span class="o">=</span> <span class="n">authinfo</span><span class="p">[</span><span class="s">&#39;auth_username&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">realm</span> <span class="o">=</span> <span class="n">authinfo</span><span class="p">[</span><span class="s">&#39;auth_realm&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">password</span> <span class="o">=</span> <span class="n">authinfo</span><span class="p">[</span><span class="s">&#39;auth_password&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="n">authinfo</span><span class="p">[</span><span class="s">&#39;auth_uri&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">qop</span> <span class="o">=</span> <span class="n">authinfo</span><span class="p">[</span><span class="s">&#39;auth_qop&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">body</span><span class="o">=</span> <span class="n">authinfo</span><span class="p">[</span><span class="s">&#39;auth_body&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">nonce</span> <span class="o">=</span> <span class="n">authinfo</span><span class="p">[</span><span class="s">&#39;auth_nonce&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">nc</span> <span class="o">=</span> <span class="n">authinfo</span><span class="p">[</span><span class="s">&#39;auth_nc&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">cnonce</span> <span class="o">=</span> <span class="n">authinfo</span><span class="p">[</span><span class="s">&#39;auth_cnonce&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">A1</span> <span class="o">=</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">realm</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">password</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">qop</span> <span class="o">==</span> <span class="s">&quot;auth-int&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">A2</span> <span class="o">=</span> <span class="n">method</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">uri</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="c"># &quot;qop&quot; directive&#39;s value is &quot;auth&quot; or is unspecified</span>
</span><span class='line'>    <span class="n">A2</span> <span class="o">=</span> <span class="n">method</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">uri</span>
</span><span class='line'>
</span><span class='line'>  <span class="c">#print &quot;A1: %s\nA2:%s&quot; % (A1, A2)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">qop</span> <span class="o">==</span> <span class="s">&#39;auth&#39;</span> <span class="ow">or</span> <span class="n">qop</span> <span class="o">==</span> <span class="s">&#39;auth-int&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="c"># OMA</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">KD</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">A1</span><span class="p">),</span> <span class="n">nonce</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">nc</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">cnonce</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">qop</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">A2</span><span class="p">))</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="c"># &quot;qop&quot; directive is not present (Ph0+)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">KD</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">A1</span><span class="p">),</span> <span class="n">nonce</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="n">H</span><span class="p">(</span><span class="n">A2</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_auth_response</span><span class="p">():</span>
</span><span class='line'>  <span class="c"># Ph0+</span>
</span><span class='line'>  <span class="c"># test auth</span>
</span><span class='line'>  <span class="n">response</span> <span class="o">=</span> <span class="n">auth_response</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">auth_realm</span> <span class="o">=</span> <span class="s">&#39;PoC Service C1.0&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_username</span> <span class="o">=</span> <span class="s">&#39;user100801@henry.poc.com&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_password</span> <span class="o">=</span> <span class="s">&#39;password&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_uri</span> <span class="o">=</span> <span class="s">&#39;sip:henry.poc.com&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_algorithm</span> <span class="o">=</span> <span class="s">&#39;MD5&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_nonce</span> <span class="o">=</span> <span class="s">&#39;b2c015055a88faed30bae04fb2d600ba&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_qop</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_nc</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_cnonce</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_body</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>                          <span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="c">#print response</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">expect_response</span> <span class="o">=</span> <span class="s">&#39;5249e6261d8d8268176230c9aea6bb69&#39;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">expect_response</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;auth - OK&quot;</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;auth - Failed&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># OMA</span>
</span><span class='line'>  <span class="c"># test auth-int</span>
</span><span class='line'>  <span class="n">response</span> <span class="o">=</span> <span class="n">auth_response</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">auth_realm</span> <span class="o">=</span> <span class="s">&#39;PoC Service C1.0&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_username</span> <span class="o">=</span> <span class="s">&#39;user100802@henry.poc.com&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_password</span> <span class="o">=</span> <span class="s">&#39;password&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_uri</span> <span class="o">=</span> <span class="s">&#39;sip:henry.poc.com;transport=UDP&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_algorithm</span> <span class="o">=</span> <span class="s">&#39;MD5&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_nonce</span> <span class="o">=</span> <span class="s">&#39;N0h9zqzvTnkAADgZVsBplA==&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_qop</span> <span class="o">=</span> <span class="s">&#39;auth-int&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_nc</span> <span class="o">=</span> <span class="s">&#39;00000001&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_cnonce</span> <span class="o">=</span> <span class="s">&#39;14d4043e584b63d901366cd5a64d8f66&#39;</span><span class="p">,</span>
</span><span class='line'>                           <span class="n">auth_body</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class='line'>                          <span class="p">))</span>
</span><span class='line'>  <span class="n">expect_response</span> <span class="o">=</span> <span class="s">&#39;76f8201f832b94e8120daaab94b55a63&#39;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">expect_response</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;auth-int - OK&quot;</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;auth-int - Failed&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="n">test_auth_response</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/11/when-call-register-handle-in-ace/">ACE中register_handler()的调用时机</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-11T09:36:00-07:00" pubdate data-updated="true">Sep 11<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/09/11/when-call-register-handle-in-ace/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这个问题源自ACE邮件列表中使用Reactor来进行串口通信的问题，
最后的根因时因为调用<code>register_handler()</code>的时机不对，
还没有调用<code>connect()</code>，就调用了<code>register_handler()</code>，
这个时候要注册的句柄因为没有建立连接，值还是-1，注册会失败，导致后续不能获得串口上的数据是理所当然的了。</p>

<p>总结一下Reactor中<code>register_handler()</code>/<code>remove_handler()</code>的调用顺序就是：</p>

<pre><code>connect()/accept()   -&gt;  register_handler()
remove_handler() -&gt; close()
</code></pre>

<p>附讨论的原始信息：</p>

<blockquote><p>Great news :)  Also, don&#8217;t forget to do the reverse when cleaning up:  Call remove_handler() *before* closing the port or you&#8217;ll see a fault on shutdown.  Basically, the sequence is &#8220;connect port -> register_handler() -> (do serial stuff) -> remove_handler() -> close port&#8221;.  Finally, don&#8217;t try this on Win32 platforms :)</p><p>- Bob</p><p><br/> &#8212;&#8212;<br/>Hi Bob,</p><p>that´s the error. When I&#8217;d started I had in the right order, but cause it wasn´t running (due to some further errors) I tried some things and totally forgot to change it back. Thank you so much^^.</p><p>Greetings,<br/>Daniel</p><p>@Andreas: I didn´t need to try your version.^^ But thx anyway&#8230;</p><p>&#8212;&#8212;&#8211; Original-Nachricht &#8212;&#8212;&#8211;<br/>> Datum: Fri, 6 Nov 2009 08:19:09 -0500<br/>> Von: robert.ciora@us.transport.bombardier.com<br/>> An: &#8220;Daniel Kempcke&#8221; <Daniel.Kempcke@gmx.net><br/>> CC: ace-users@list.isis.vanderbilt.edu, ace-users-bounces@list.isis.vanderbilt.edu<br/>> Betreff: Re: [ace-users] Problem reactor used with serial interface</p><p>> Daniel,<br/>><br/>> Another quick one:  You&#8217;re calling &#8220;reactor()->register_handler(&#8230;)&#8221;<br/>> before calling &#8220;connector->connect(&#8230;)&#8221;.  The register_handler() will use<br/>> your get_handle() to determine which handle to register.  Since you<br/>> haven&#8217;t connected the port yet, your get_handle() (which calls<br/>> peer_.get_handle()) is returning ACE_INVALID_HANDLE.  It&#8217;s in the<br/>> connect() call where the peer&#8217;s handle gets set to something valid.<br/>><br/>> Try calling register_handler() *after* calling connect().<br/>><br/>> - Bob<br/>><br/>><br/>><br/>> Please consider the environment before you print / Antes de imprimir,<br/>> piense en el medio ambiente<br/>><br/>> &#8220;Daniel Kempcke&#8221; <Daniel.Kempcke@gmx.net><br/>> Sent by: ace-users-bounces@list.isis.vanderbilt.edu<br/>> 11/06/2009 04:06 AM<br/>><br/>> To<br/>> ace-users@list.isis.vanderbilt.edu<br/>> cc<br/>><br/>> Subject<br/>> Re: [ace-users] Problem reactor used with serial interface<br/>><br/>><br/>> Hi Bob,<br/>><br/>> I tried it with -1 (and also with some other values). But the behaviour<br/>> didn&#8217;t change.<br/>> But anyway - thx for your response&#8230;<br/>><br/>> Daniel<br/>><br/>> &#8212;&#8212;&#8211; Original-Nachricht &#8212;&#8212;&#8211;<br/>> > Datum: Thu, 5 Nov 2009 10:41:30 -0500<br/>> > Von: robert.ciora@us.transport.bombardier.com<br/>> > An: &#8220;Daniel Kempcke&#8221; <Daniel.Kempcke@gmx.net><br/>> > CC: ace-users@list.isis.vanderbilt.edu,<br/>> ace-users-bounces@list.isis.vanderbilt.edu<br/>> > Betreff: Re: [ace-users] Problem reactor used with serial interface<br/>><br/>> > Daniel,<br/>> ><br/>> > As a quick guess: try setting your serial parameters&#8217; &#8220;readtimeoutmsec&#8221;<br/>> > field to -1.  This *should* cause the reactor (select() call) to<br/>> correctly<br/>> > block on the handle.<br/>> ><br/>> > - Bob<br/>> ><br/>> ><br/>> > Please consider the environment before you print / Antes de imprimir,<br/>> > piense en el medio ambiente<br/>> ><br/>> ><br/>> > &#8220;Daniel Kempcke&#8221; <Daniel.Kempcke@gmx.net><br/>> > Sent by: ace-users-bounces@list.isis.vanderbilt.edu<br/>> > 11/05/2009 10:21 AM<br/>> ><br/>> > To<br/>> > ace-users@list.isis.vanderbilt.edu<br/>> > cc<br/>> ><br/>> > Subject<br/>> > [ace-users] Problem reactor used with serial interface<br/>> ><br/>> > To: ace-bugs@cs.wustl.edu<br/>> > Subject: [area]: [synopsis]<br/>> ><br/>> >     ACE VERSION: 5.6.3<br/>> ><br/>> >     HOST MACHINE and OPERATING SYSTEM:<br/>> >     - Linux - Ubuntu 9.04 - Kernel 2.6.28<br/>> ><br/>> ><br/>> ><br/>> >     TARGET MACHINE and OPERATING SYSTEM, if different from HOST:<br/>> >     -<br/>> >     COMPILER NAME AND VERSION (AND PATCHLEVEL):<br/>> >     - g++ Version 4.3.3<br/>> ><br/>> ><br/>> >     BUILD METHOD USED:<br/>> > [Experimental ./configure or traditional makefile/project file?]<br/>> >     - makefile/project file<br/>> ><br/>> ><br/>> >     AREA/CLASS/EXAMPLE AFFECTED:<br/>> > [What example failed?  What module failed to compile?]<br/>> ><br/>> > Example for using the Reactor with a serial device and not with TCP/IP<br/>> as<br/>> > a data source. Compiling didn´t fail.<br/>> ><br/>> ><br/>> >     DOES THE PROBLEM AFFECT:<br/>> >         COMPILATION? -<br/>> >         LINKING? -<br/>> >             On Unix systems, did you run make realclean first?<br/>> >             - yes<br/>> >         EXECUTION?<br/>> >         - fails (no signal, caused by data input from the serial device,<br/>><br/>> > occurs)<br/>> ><br/>> ><br/>> >     DESCRIPTION:<br/>> ><br/>> >     The application uses the reactor. There is a serial device on which<br/>> > constantly data arrives. The applic just opens the serial connection and<br/>><br/>> > registers a handler to it. Then it starts the run_reactor_event_loop -<br/>> in<br/>> > this case without an exit conditions.<br/>> ><br/>> ><br/>> > The application uses the standard reactor methods:<br/>> ><br/>> > The &#8220;open()&#8221; method registers a handler, makes a connect to the serial<br/>> > device and sets the serial parameters.<br/>> > The &#8220;handle_input()&#8221; method doesn´t have to do anythng special. In this<br/>> > example it shall only dislay the received data.<br/>> > &#8220;Handle_close()&#8221; just removes the handler, closes the serial connection<br/>> > and deletes the object.<br/>> ><br/>> ><br/>> > Normally I would expect, that the reactor would get signals - cause of<br/>> the<br/>> > incoming data on the serial interface - from the OS, which causes calls<br/>> of<br/>> > the &#8220;handle_input()&#8221; method.<br/>> > But nothing happens - the &#8220;handle_input()&#8221; routine&#8217;s never been called,<br/>> > despite there´s always data arriving on the serial interface.<br/>> ><br/>> > I tried also other examples, which were available online. They are<br/>> similar<br/>> > structured and also never reach the &#8220;handle_input()&#8221;.<br/>> ><br/>> ><br/>> > here´s the code example:<br/>> ><br/>> ><br/>> > #include &#8220;ace/DEV_Connector.h&#8221;<br/>> > #include &#8220;ace/TTY_IO.h&#8221;<br/>> > #include &#8220;ace/Time_Value.h&#8221;<br/>> > #include &#8220;ace/Reactor.h&#8221;<br/>> ><br/>> > #include <iostream><br/>> ><br/>> > class Service : public ACE_Event_Handler{<br/>> > public:<br/>> >                  Service();<br/>> >                  virtual ~Service();<br/>> ><br/>> >                  int open(const char *, ACE_TTY_IO::Serial_Params&<br/>> > sSerialParams);<br/>> ><br/>> >                  virtual ACE_HANDLE get_handle(void) const<br/>> >                  {<br/>> >                                  return this->peer_.get_handle();<br/>> >                  }<br/>> ><br/>> >                  virtual int handle_input(ACE_HANDLE fd =<br/>> > ACE_INVALID_HANDLE);<br/>> ><br/>> >                  virtual int handle_close(ACE_HANDLE handle,<br/>> > ACE_Reactor_Mask close_mask);<br/>> ><br/>> > protected:<br/>> >                  ACE_DEV_Connector connector_;<br/>> >                  //ACE_Message_Queue<ACE_NULL_SYNC> output_queue;<br/>> ><br/>> > private:<br/>> >                  ACE_TTY_IO peer_;<br/>> > };<br/>> ><br/>> ><br/>> > int open(const char* name, ACE_TTY_IO::Serial_Params& sSerialParams) {<br/>> ><br/>> >                  int nResult = 0;<br/>> ><br/>> >                  ACE_Reactor::instance()->register_handler(this,<br/>> >  ACE_Event_Handler::READ_MASK);<br/>> > // Set our I/O handle to that of the peer_ object handling our<br/>> connection<br/>> > if (this->connector_.connect(peer_, ACE_DEV_Addr(name), 0,<br/>> >                                                  ACE_Addr::sap_any, 0,<br/>> > //reuse<br/>> >                                                  O_RDWR |<br/>> > FILE_FLAG_OVERLAPPED) != 0) {<br/>> >                                  ACE_ERROR((LM_ERROR, ACE_TEXT(&#8220;%p\n&#8221;),<br/>> >                  ACE_TEXT(&#8220;&#8212; SerialIOHandler connect\n&#8221;)));<br/>> >                                  nResult = -1;<br/>> >                  }<br/>> ><br/>> >                  if (peer_.control(ACE_TTY_IO::SETPARAMS,<br/>> &sSerialParams)<br/>> > != 0) {<br/>> >                                  ACE_ERROR((LM_ERROR, ACE_TEXT(&#8220;%p<br/>> > control\n&#8221;), name));<br/>> >                                  nResult = -1;<br/>> >                  }<br/>> ><br/>> ><br/>> >                  return nResult;<br/>> > }<br/>> ><br/>> > int handle_input(ACE_HANDLE) {<br/>> >                  char *readBack;<br/>> >                  peer_.recv((void *) &readBack, 1);<br/>> ><br/>> >                  cout << readBack << endl;<br/>> ><br/>> >                  return 0;<br/>> > }<br/>> ><br/>> > int handle_close(ACE_HANDLE handle, ACE_Reactor_Mask close_mask) {<br/>> ><br/>> >                  if (this->peer_.get_handle() != ACE_INVALID_HANDLE) {<br/>> >                                  ACE_Reactor_Mask m =<br/>> > ACE_Event_Handler::ACCEPT_MASK<br/>> >                                                                  |<br/>> > ACE_Event_Handler::DONT_CALL;<br/>> ><br/>> >                                  this->reactor()->remove_handler(this,<br/>> m);<br/>> >                                  this->peer_.close();<br/>> ><br/>> >                                  delete this;<br/>> >                                  return 0;<br/>> >                  }<br/>> >                  return 0;<br/>> > }<br/>> ><br/>> ><br/>> > int ACE_TMAIN(int, ACE_TCHAR *[]) {<br/>> ><br/>> >                  Service SerialIO0;<br/>> >                  Service SerialIO1;<br/>> ><br/>> >                  ACE_TTY_IO::Serial_Params sSerialParams;<br/>> >            sSerialPortParams.baudrate = 115200;<br/>> >                     sSerialPortParams.xonlim = 0;<br/>> >                     sSerialPortParams.xofflim = 0;<br/>> >                     sSerialPortParams.readmincharacters = 0;<br/>> >                     sSerialPortParams.readtimeoutmsec = 1000; // 1<br/>> second<br/>> >                     sSerialPortParams.paritymode = &#8220;none&#8221;;<br/>> >                     sSerialPortParams.ctsenb = false;<br/>> >                     sSerialPortParams.rtsenb = 0;<br/>> >                     sSerialPortParams.xinenb = false;<br/>> >                     sSerialPortParams.xoutenb = false;<br/>> >                     sSerialPortParams.modem = false;<br/>> >                     sSerialPortParams.rcvenb = true;<br/>> >                     sSerialPortParams.dsrenb = false;<br/>> >                     sSerialPortParams.dtrdisable = false;<br/>> >                     sSerialPortParams.databits = 8;<br/>> >                     sSerialPortParams.stopbits = 1;<br/>> ><br/>> ><br/>> >                  const char * serName0 = &#8220;/dev/ttyUSB0&#8221;;<br/>> >                  const char * serName1 = &#8220;/dev/ttyUSB1&#8221;;<br/>> ><br/>> ><br/>> >                  if (SerialIO0.open(serName0, sSerialParams) == -1)<br/>> >                  {<br/>> >                                  cout << "could not connect to: " <<<br/>> > serName0 << endl;<br/>> >                                  return 1;<br/>> >                  }<br/>> ><br/>> >                  if (SerialIO1.open(serName1, sSerialParams) == -1)<br/>> >                  {<br/>> >                                  cout << "could not connect to: " <<<br/>> > serName1 << endl;<br/>> >                                  return 1;<br/>> >                  }<br/>> ><br/>> >                  cout << "connected to: " << serName0 << " " << serName1<br/>><br/>> > << endl;<br/>> ><br/>> ><br/>> >                  ACE_Reactor::instance()->run_reactor_event_loop();<br/>> ><br/>> >                  return 0;<br/>> > }<br/>> ><br/>> > Would be great if somebody could give me a little help. Thanks a lot in<br/>> > advance.<br/>> > Best regards,<br/>> > Daniel<br/>> ></p></blockquote>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/05/05/how-to-setup-rhel-kdump/">How to Setup RHEL Kdump</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-05-05T22:39:00-07:00" pubdate data-updated="true">May 5<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/05/05/how-to-setup-rhel-kdump/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><code>Kdump</code>是一种调试Linux内核的方法，
用于在Linux内核出现<code>Oops</code>之后自动dump内核映像到指定位置的机制，
便于我们的事后调试。</p>

<blockquote><p>Kdump is a new kernel crash dumping mechanism and is very reliable.<br/>The crash dump is captured from the context of a freshly booted kernel<br/>and not from the context of the crashed kernel.<br/>Kdump uses kexec to boot into a second kernel whenever the system crashes.<br/>This second kernel, often called a capture kernel, boots with very little<br/>memory and captures the dump image.</p></blockquote>


<ol>
<li>Install <code>kexec-tools</code></li>
</ol>


<p>Install by <code>yum</code>:</p>

<pre><code>yum install kexec-tools
</code></pre>

<ol>
<li>write kdump config file <code>/etc/kdump.conf</code></li>
</ol>


<p>An example with following content.</p>

<pre><code>path /var/crash
core_collector makedumpfile -d 31 -c
</code></pre>

<ol>
<li>change <code>/etc/grub.conf</code> append <code>crashkernel=128M@16M</code> to the end of kernel line.</li>
</ol>


<p>An example of <code>/etc/grub.conf</code></p>

<pre><code>default=0
timeout=5
splashimage=(hd0,0)/grub/splash.xpm.gz
hiddenmenu
title Red Hat Enterprise Linux Server (2.6.18-128.el5)
        root (hd0,0)
        kernel /vmlinuz-2.6.18-128.el5 ro root=/dev/mapper/luks-10d5d533-38f6-482c-982d-bfb488adfbed
 rhgb quiet crashkernel=128M@16M
        initrd /initrd-2.6.18-128.el5.img
</code></pre>

<ol>
<li>post config</li>
</ol>


<p>Set <code>kdump</code> service automatically start with system startup.</p>

<pre><code>chkconfig kdump on
service kdump start
reboot
</code></pre>

<p>After system reboot, the kdump is ready. the kernel crash file is located at <code>/var/crash/</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/03/06/drbd/">DRBD实践</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-03-06T22:31:00-08:00" pubdate data-updated="true">Mar 6<span>th</span>, 2009</time>
        
         | <a href="/blog/2009/03/06/drbd/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>实验环境</h2>

<pre><code>OS：RHEL 5.2 64bit
DRBD 8.2.6
</code></pre>

<h2>硬件配置：</h2>

<ul>
<li>三个物理网卡(注[1])（2个用于bonding，一个用于心跳。）</li>
<li>在两台机器上分别分配一个4G的分区。</li>
</ul>


<h2>准备工作</h2>

<p>为了测试方便，先划一个2G大小的逻辑分区出来。</p>

<pre><code># lvcreate –L 2G –n lvol0 vg1
</code></pre>

<p>划一个分区来做<code>meta-disk</code></p>

<pre><code># lvcreate –L 200M –n metadisk vg1
</code></pre>

<h2>编译</h2>

<pre><code># tar zxvf drbd-8.2.6.tar.gz
# cd drbd-8.2.6/drbd
# make clean all
# cd ../
# make tools
# make install
</code></pre>

<h2>配置</h2>

<p>配置文件：<code>/etc/drbd.conf</code></p>

<p>样例文件：</p>

<p>使用scp把<code>/etc/drbd.conf</code>拷贝到另一台运行DBRD的机器上。</p>

<pre><code># scp /etc/drbd.conf root@ssa-1:/etc/drbd.conf
</code></pre>

<p>创建DRBD记录信息数据块，分别在两台机器上执行如下命令：</p>

<pre><code>ssa-0 # drbdadm create-md r0
ssa-1 # drbdadm create-md r0
</code></pre>

<h2>启动DRBD</h2>

<p>需要在两台机器上同时启动DRBD服务：</p>

<pre><code>ssa-0#/etc/init.d/drbd start
ssa-1#/etc/init.d/drbd start
</code></pre>

<h2>检查DBRD状态</h2>

<pre><code># cat /proc/drbd
</code></pre>

<p><code>st</code>表示主备状态。</p>

<h2>操作DRBD</h2>

<p>把当前的主机设置主机</p>

<pre><code>ssa-0# drbdsetup /dev/drbd1 primary -o
</code></pre>

<p>创建文件系统</p>

<pre><code>mkfs.ext3 –j /dev/drbd1
</code></pre>

<p>把当前的主机设置为备机。需要先卸下挂载的DRBD设备：</p>

<pre><code># umount /dev/drbd1
</code></pre>

<p>然后执行如下命令：</p>

<pre><code># drbdadm secondary r0
</code></pre>

<p>把备机升级为主机：</p>

<pre><code># drbdadm primary r0
</code></pre>

<h2>参考资料</h2>

<ul>
<li><a href="http://www.drbd.org/docs">http://www.drbd.org/docs</a></li>
<li>man drbd.conf</li>
</ul>


<p>注：[1] 也可以只使用2个网卡，把心跳合在bonding网卡上。建议把心跳的网卡单独出来。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/24/sys-call-table-undefined-and-how-to-replace-syscall/">Sys_call_table符号链接失败及如何替换系统调用</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-24T22:15:00-08:00" pubdate data-updated="true">Nov 24<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/11/24/sys-call-table-undefined-and-how-to-replace-syscall/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>2.4的内核中可以通过修改<code>sys_call_table</code>来很轻松的替换系统调用，
来完成很多trick，很多的<code>rootkit</code>就是基于这种手法来完成的。
到了2.6的内核，事情就不是这么回事了，<code>sys_call_table</code>不再被export出来了。
这样的话就不能简单通过修改<code>sys_call_table</code>来替换系统调用了。如果再继续使用<code>sys_call_table</code>的话，将会得到类似如下的警告：</p>

<pre><code>WARNING: "sys_call_table" [/mnt/linux/km/lpp/src/lpp.ko] undefined!
</code></pre>

<p>当然，加载模块也会失败的:</p>

<pre><code># insmod lpp.ko
insmod: error inserting 'lpp.ko': -1 Unknown symbol in module
# dmesg
lpp: Unknown symbol sys_call_table
</code></pre>

<p>当然，虽然没有export出来，但我们还是有办法获取到<code>sys_call_table</code>的，
在C语言中，<code>sys_call_table</code>也就是一个地址而已，我们的问题就是如何获取这个地址。</p>

<p>有如下2种方法。</p>

<p>方法1：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">**</span><span class="nf">find_sys_call_table</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">**</span><span class="n">sctable</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">extern</span> <span class="kt">int</span> <span class="n">loops_per_jiffy</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sctable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">loops_per_jiffy</span><span class="p">;</span>
</span><span class='line'>        <span class="n">ptr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">boot_cpu_data</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)){</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">__NR_close</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sys_close</span><span class="p">){</span>
</span><span class='line'>            <span class="n">sctable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">**</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">&amp;</span><span class="n">sctable</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">**</span><span class="n">sys_call_table</span> <span class="o">=</span> <span class="n">find_sys_call_table</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>一个完整的示例：
<a href="http://www.gnome.org/~lcolitti/gnome-startup/linux-iolog/readlog.c">http://www.gnome.org/~lcolitti/gnome-startup/linux-iolog/readlog.c</a></p>

<p>注意，在最新的内核2.6.30的内核它不能编译，需要对第52行进行修改：</p>

<pre><code>52c52
&lt;         f = current-&gt;files-&gt;fd[fd];
---
&gt;         f = current-&gt;files-&gt;fd_array[fd];
</code></pre>

<p>方法2：去<code>System.map</code>中找。</p>

<pre><code>grep sys_call_table /boot/System.map
</code></pre>

<p>方法3：当然你也可以直接修改内核代码，然后再重新编译内核。</p>

<p>2.6的内核之所以不把<code>sys_call_table</code>给export出来，不仅仅是因为安全的原因，
另外一个原因是我们真正的需要在内核去替换系统调用吗?</p>

<p>在用户空间，我们照样也能完成系统调用的替换，为什么不在用户空间去做呢？
使用Linux的<code>LD_PRELOAD</code>特性，Linux的man page对<code>LD_PRELOAD</code>的解释：</p>

<blockquote><p>LD_PRELOAD<br/>      A whitespace-separated list of additional, user-specified, ELF<br/>      shared libraries to be loaded before all others. This can be<br/>      used to selectively  override  functions in other shared<br/>      libraries. For setuid/setgid  ELF binaries, only libraries in<br/>      the standard search directories that are also setgid will be<br/>      loaded.</p></blockquote>


<p>借助LD_PRELOAD我们可以在用户空间轻松完成所有系统调用的替换。
比如我们写一个动态库，源代码如下：</p>

<figure class='code'><figcaption><span>演示如何截获系统调用 </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#define __USE_GNU</span>
</span><span class='line'><span class="cp">#include &lt;dlfcn.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">readfn</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Preloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">readfn</span> <span class="o">=</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">RTLD_NEXT</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">ssize_t</span> <span class="nf">read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;My read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">readfn</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>编译：</p>

<pre><code>gcc -shared -g -o libcm.so -ldl
</code></pre>

<p>然后再这样使用<code>LD_PRELOAD</code>：</p>

<pre><code>LD_PRELOAD=./libcm.so ./a.out
</code></pre>

<p>这样a.out里面所有的read调用都会进入到我们read函数中去了。</p>

<p>参考：</p>

<ul>
<li><a href="http://kerneltrap.org/node/5802">http://kerneltrap.org/node/5802</a></li>
<li><a href="http://kerneltrap.org/node/5793">http://kerneltrap.org/node/5793</a></li>
<li><a href="http://en.wikipedia.org/wiki/Dynamic_linker">http://en.wikipedia.org/wiki/Dynamic_linker</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/04/16/handle-exception-in-gdb/">使用gdb调试异常</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-04-16T22:05:00-07:00" pubdate data-updated="true">Apr 16<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/04/16/handle-exception-in-gdb/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>有时程序中有未捕获的异常会导致程序异常的行为甚至导致程序的直接退出。
这对服务器程序来说是不可接受的。</p>

<p>可以使用<code>gdb</code>的<code>catch</code>命令来帮助我们调试异常。</p>

<p>使用<code>gdb</code>捕获异常的扔出点（相当于在扔出异常的地方添加断点）：</p>

<pre><code>catch throw
</code></pre>

<p>使用gdb捕获线程退出（相当于在线程退出的时候添加断点）：</p>

<pre><code>catch pthread_exit
</code></pre>

<p>这样，如果相应的事件发生，<code>gdb</code>就会中断程序的执行，
就可以使用<code>gdb</code>的<code>bt</code>命令来检查出现错误的调用栈了。</p>

<p>更多信息：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) help catch
</span><span class='line'>Set catchpoints to catch events.
</span><span class='line'>Raised signals may be caught:
</span><span class='line'>  catch signal              - all signals
</span><span class='line'>  catch signal &lt;signame>    - a particular signal
</span><span class='line'>Raised exceptions may be caught:
</span><span class='line'>  catch throw               - all exceptions, when thrown
</span><span class='line'>  catch throw &lt;exceptname>  - a particular exception, when thrown
</span><span class='line'>  catch catch               - all exceptions, when caught
</span><span class='line'>  catch catch &lt;exceptname>  - a particular exception, when caught
</span><span class='line'>Thread or process events may be caught:
</span><span class='line'>  catch thread_start        - any threads, just after creation
</span><span class='line'>  catch thread_exit         - any threads, just before expiration
</span><span class='line'>  catch thread_join         - any threads, just after joins
</span><span class='line'>Process events may be caught:
</span><span class='line'>  catch start               - any processes, just after creation
</span><span class='line'>  catch exit                - any processes, just before expiration
</span><span class='line'>  catch fork                - calls to fork()
</span><span class='line'>  catch vfork               - calls to vfork()
</span><span class='line'>  catch exec                - calls to exec()
</span><span class='line'>Dynamically-linked library events may be caught:
</span><span class='line'>  catch load                - loads of any library
</span><span class='line'>  catch load &lt;libname>      - loads of a particular library
</span><span class='line'>  catch unload              - unloads of any library
</span><span class='line'>  catch unload &lt;libname>    - unloads of a particular library
</span><span class='line'>The act of your program's execution stopping may also be caught:
</span><span class='line'>  catch stop
</span><span class='line'>
</span><span class='line'>C++ exceptions may be caught:
</span><span class='line'>  catch throw               - all exceptions, when thrown
</span><span class='line'>  catch catch               - all exceptions, when caught
</span><span class='line'>
</span><span class='line'>Do "help set follow-fork-mode" for info on debugging your program
</span><span class='line'>after a fork or vfork is caught.
</span><span class='line'>
</span><span class='line'>Do "help breakpoints" for info on other commands dealing with breakpoints.</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/03/08/ace-message-queue-notify-deadlock-in-reactor/">ACE_Message_Queue的notify和Reactor结合使用时会导致死锁</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-03-08T22:00:00-08:00" pubdate data-updated="true">Mar 8<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/03/08/ace-message-queue-notify-deadlock-in-reactor/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>现象</h2>

<p>设置了Queue的通知策略之后，在<code>putq</code>之后会调用Reactor的<code>notify</code>方法，
Reactor内部使用一个管道来传输通知事件，导致在写入通知事件时阻塞在该管道上，
从而导致程序挂起。</p>

<p>这是一个很早就发现的bug，但是一直没有被修正。一方面是它不好修正，
从邮件列表里得到的信息是ACE的维护者缺乏资金解决这个问题。</p>

<h2>一个示例的调用栈</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) thr app all bt
</span><span class='line'>
</span><span class='line'>Thread 4 (Thread 0xb7ad3b90 (LWP 31160)):   # ---- Scheduler thread.
</span><span class='line'>#0  0xb80da430 in __kernel_vsyscall ()
</span><span class='line'>#1  0xb7f790e5 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/tls/i686/cmov/libpthread.so.0
</span><span class='line'>#2  0x08070c59 in ACE_OS::cond_wait (cv=0x91a7cbc, external_mutex=0x91a7ca0)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/OS_NS_Thread.inl:329
</span><span class='line'>#3  0x08070c9f in ACE_Condition&lt;ACE_Thread_Mutex>::wait (this=0x91a7cbc)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/Condition_T.cpp:90
</span><span class='line'>#4  0x0807020a in cm::Scheduler::choose_processor (this=0x91a7c54)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/Scheduler.cpp:94
</span><span class='line'>#5  0x080705ad in cm::Scheduler::svc (this=0x91a7c54)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/Scheduler.cpp:80
</span><span class='line'>#6  0xb7daae52 in ACE_Task_Base::svc_run (args=0x91a7c54) at Task.cpp:275
</span><span class='line'>#7  0xb7dac2ed in ACE_Thread_Adapter::invoke_i (this=0x91a7fa0) at Thread_Adapter.cpp:149
</span><span class='line'>#8  0xb7dac366 in ACE_Thread_Adapter::invoke (this=0x91a7fa0) at Thread_Adapter.cpp:98
</span><span class='line'>#9  0xb7d33271 in ace_thread_adapter (args=0x91a7fa0) at Base_Thread_Adapter.cpp:124
</span><span class='line'>#10 0xb7f754ff in start_thread () from /lib/tls/i686/cmov/libpthread.so.0
</span><span class='line'>#11 0xb7ef049e in clone () from /lib/tls/i686/cmov/libc.so.6
</span><span class='line'>
</span><span class='line'>Thread 3 (Thread 0xb72d2b90 (LWP 31161)):   # ---- Processor thread.
</span><span class='line'>#0  0xb80da430 in __kernel_vsyscall ()
</span><span class='line'>#1  0xb7f7c07b in write () from /lib/tls/i686/cmov/libpthread.so.0
</span><span class='line'>#2  0xb7d212ea in ACE::send (handle=6, buf=0xb72cff34, n=8, timeout=0x8)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/OS_NS_unistd.inl:1200
</span><span class='line'>#3  0xb7d4da29 in ACE_Dev_Poll_Reactor_Notify::notify (this=0x91a3c10, eh=0x92095b0, mask=2,
</span><span class='line'>    timeout=0x0) at Dev_Poll_Reactor.cpp:165
</span><span class='line'>#4  0xb7d4bcbc in ACE_Dev_Poll_Reactor::notify (this=0x91a3980, eh=0x92095b0, mask=2,
</span><span class='line'>    timeout=0x0) at Dev_Poll_Reactor.cpp:2028
</span><span class='line'>#5  0xb7d9550e in ACE_Reactor::notify (this=0x91a38c0, event_handler=0x92095b0, mask=2, tv=0x0)
</span><span class='line'>    at Reactor.cpp:481
</span><span class='line'>#6  0xb7d95e76 in ACE_Reactor_Notification_Strategy::notify (this=0x9209638)
</span><span class='line'>    at Reactor_Notification_Strategy.cpp:28
</span><span class='line'>#7  0x08062d47 in ACE_Message_Queue&lt;ACE_MT_SYNCH>::notify (this=0x9209660)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/Message_Queue_T.cpp:1998
</span><span class='line'>#8  0x080650cc in ACE_Message_Queue&lt;ACE_MT_SYNCH>::enqueue_tail (this=0x9209660,
</span><span class='line'>    new_item=0xb61bb3d8, timeout=0xb72d0064)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/Message_Queue_T.cpp:1888
</span><span class='line'>#9  0x08076c2c in ACE_Task&lt;ACE_MT_SYNCH>::putq (this=0x92095b0, mb=0xb61bb3d8, tv=0xb72d0064)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/Task_T.inl:36
</span><span class='line'>#10 0x08075653 in cm::RequestHandler::async_send (this=0x92095b0, mb=0xb61bb3d8)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/RequestHandler.cpp:257
</span><span class='line'>#11 0x080746ef in cm::HttpTransaction::send_static_file (this=0x9209d10, uri=@0xb72d2288)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/HttpTransaction.cpp:98
</span><span class='line'>#12 0x08074c8b in cm::HttpTransaction::execute (this=0x9209d10)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/HttpTransaction.cpp:37
</span><span class='line'>#13 0x080712a0 in cm::Processor::svc (this=0x91aa128)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/Processor.cpp:47
</span><span class='line'>#14 0xb7daae52 in ACE_Task_Base::svc_run (args=0x91aa128) at Task.cpp:275
</span><span class='line'>#15 0xb7dac2ed in ACE_Thread_Adapter::invoke_i (this=0x91aa330) at Thread_Adapter.cpp:149
</span><span class='line'>#16 0xb7dac366 in ACE_Thread_Adapter::invoke (this=0x91aa330) at Thread_Adapter.cpp:98
</span><span class='line'>#17 0xb7d33271 in ace_thread_adapter (args=0x91aa330) at Base_Thread_Adapter.cpp:124
</span><span class='line'>#18 0xb7f754ff in start_thread () from /lib/tls/i686/cmov/libpthread.so.0
</span><span class='line'>#19 0xb7ef049e in clone () from /lib/tls/i686/cmov/libc.so.6
</span><span class='line'>
</span><span class='line'>Thread 2 (Thread 0xb6ad1b90 (LWP 31162)):   # ---- Processor thread
</span><span class='line'>#0  0xb80da430 in __kernel_vsyscall ()
</span><span class='line'>#1  0xb7f7c07b in write () from /lib/tls/i686/cmov/libpthread.so.0
</span><span class='line'>#2  0xb7d212ea in ACE::send (handle=6, buf=0xb6acef34, n=8, timeout=0x8)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/OS_NS_unistd.inl:1200
</span><span class='line'>#3  0xb7d4da29 in ACE_Dev_Poll_Reactor_Notify::notify (this=0x91a3c10, eh=0x9209448, mask=2,
</span><span class='line'>    timeout=0x0) at Dev_Poll_Reactor.cpp:165
</span><span class='line'>#4  0xb7d4bcbc in ACE_Dev_Poll_Reactor::notify (this=0x91a3980, eh=0x9209448, mask=2,
</span><span class='line'>    timeout=0x0) at Dev_Poll_Reactor.cpp:2028
</span><span class='line'>#5  0xb7d9550e in ACE_Reactor::notify (this=0x91a38c0, event_handler=0x9209448, mask=2, tv=0x0)
</span><span class='line'>    at Reactor.cpp:481
</span><span class='line'>#6  0xb7d95e76 in ACE_Reactor_Notification_Strategy::notify (this=0x92094d0)
</span><span class='line'>    at Reactor_Notification_Strategy.cpp:28
</span><span class='line'>#7  0x08062d47 in ACE_Message_Queue&lt;ACE_MT_SYNCH>::notify (this=0x92094f8)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/Message_Queue_T.cpp:1998
</span><span class='line'>#8  0x080650cc in ACE_Message_Queue&lt;ACE_MT_SYNCH>::enqueue_tail (this=0x92094f8,
</span><span class='line'>    new_item=0x92f5c38, timeout=0xb6acf064)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/Message_Queue_T.cpp:1888
</span><span class='line'>#9  0x08076c2c in ACE_Task&lt;ACE_MT_SYNCH>::putq (this=0x9209448, mb=0x92f5c38, tv=0xb6acf064)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/Task_T.inl:36
</span><span class='line'>#10 0x08075653 in cm::RequestHandler::async_send (this=0x9209448, mb=0x92f5c38)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/RequestHandler.cpp:257
</span><span class='line'>#11 0x08074917 in cm::HttpTransaction::send_static_file (this=0x9209bc0, uri=@0xb6ad1288)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/HttpTransaction.cpp:110
</span><span class='line'>#12 0x08074c8b in cm::HttpTransaction::execute (this=0x9209bc0)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/HttpTransaction.cpp:37
</span><span class='line'>#13 0x080712a0 in cm::Processor::svc (this=0x91ac488)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/Processor.cpp:47
</span><span class='line'>#14 0xb7daae52 in ACE_Task_Base::svc_run (args=0x91ac488) at Task.cpp:275
</span><span class='line'>#15 0xb7dac2ed in ACE_Thread_Adapter::invoke_i (this=0x91ac690) at Thread_Adapter.cpp:149
</span><span class='line'>#16 0xb7dac366 in ACE_Thread_Adapter::invoke (this=0x91ac690) at Thread_Adapter.cpp:98
</span><span class='line'>#17 0xb7d33271 in ace_thread_adapter (args=0x91ac690) at Base_Thread_Adapter.cpp:124
</span><span class='line'>#18 0xb7f754ff in start_thread () from /lib/tls/i686/cmov/libpthread.so.0
</span><span class='line'>#19 0xb7ef049e in clone () from /lib/tls/i686/cmov/libc.so.6
</span><span class='line'>
</span><span class='line'>Thread 1 (Thread 0xb7ad48e0 (LWP 31159)):  # ---- Reactor thread.
</span><span class='line'>#0  0xb80da430 in __kernel_vsyscall ()
</span><span class='line'>#1  0xb7f790e5 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib/tls/i686/cmov/libpthread.so.0
</span><span class='line'>#2  0xb7d3c254 in ACE_Condition_Thread_Mutex::wait (this=0x91ae99c, mutex=@0x80, abstime=0x0)
</span><span class='line'>---Type &lt;return> to continue, or q &lt;return> to quit---
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/OS_NS_Thread.inl:362
</span><span class='line'>#3  0xb7d3c2bb in ACE_Condition_Thread_Mutex::wait (this=0x91ae99c, abstime=0x0)
</span><span class='line'>    at Condition_Thread_Mutex.cpp:107
</span><span class='line'>#4  0x08063c90 in ACE_Message_Queue&lt;ACE_MT_SYNCH>::wait_not_full_cond (this=0x91ae920,
</span><span class='line'>    timeout=0x0) at /home/cm/ACE_wrappers/ace/Message_Queue_T.cpp:1715
</span><span class='line'>#5  0x08064e38 in ACE_Message_Queue&lt;ACE_MT_SYNCH>::enqueue_head (this=0x91ae920,
</span><span class='line'>    new_item=0xb6105610, timeout=0x0) at /home/cm/ACE_wrappers/ace/Message_Queue_T.cpp:1777
</span><span class='line'>#6  0x0807236a in ACE_Task&lt;ACE_MT_SYNCH>::ungetq (this=0x91ae870, mb=0xb6105610, tv=0x0)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/Task_T.inl:43
</span><span class='line'>#7  0x08071d5d in cm::HttpRequestHandler::handle_output (this=0x91ae870)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/HttpRequestHandler.cpp:86
</span><span class='line'>#8  0xb7d4d982 in ACE_Dev_Poll_Reactor_Notify::dispatch_notify (this=0x91a3c10,
</span><span class='line'>    buffer=@0xbfaf5c04) at Dev_Poll_Reactor.cpp:365
</span><span class='line'>#9  0xb7d4c91b in ACE_Dev_Poll_Reactor_Notify::handle_input (this=0x91a3c10, handle=5)
</span><span class='line'>    at Dev_Poll_Reactor.cpp:297
</span><span class='line'>#10 0xb7d4f945 in ACE_Dev_Poll_Reactor::dispatch_io_event (this=0x91a3980, guard=@0xbfaf5d14)
</span><span class='line'>    at /home/cm/ACE_wrappers/ace/Dev_Poll_Reactor.inl:126
</span><span class='line'>#11 0xb7d4fb4c in ACE_Dev_Poll_Reactor::dispatch (this=0x91a3980, guard=@0xbfaf5d14)
</span><span class='line'>    at Dev_Poll_Reactor.cpp:1079
</span><span class='line'>#12 0xb7d4fca6 in ACE_Dev_Poll_Reactor::handle_events_i (this=0x91a3980, max_wait_time=0x0,
</span><span class='line'>    guard=@0xbfaf5d14) at Dev_Poll_Reactor.cpp:1056
</span><span class='line'>#13 0xb7d4fd7c in ACE_Dev_Poll_Reactor::handle_events (this=0x91a3980, max_wait_time=0x0)
</span><span class='line'>    at Dev_Poll_Reactor.cpp:1012
</span><span class='line'>#14 0xb7d94fc3 in ACE_Reactor::run_reactor_event_loop (this=0x91a38c0, eh=0) at Reactor.cpp:224
</span><span class='line'>#15 0x08062452 in main (argc=7, argv=0xbfaf5f04)
</span><span class='line'>    at /home/cm/Dropbox/projects/ace_skel/src/main.cpp:75
</span><span class='line'>#0  0xb80da430 in __kernel_vsyscall ()</span></code></pre></td></tr></table></div></figure>


<h2>规避方法</h2>

<p>把<code>ACE_Message_Queue</code>的<code>high water level</code>设置为一个很高的值，
避免队列满触发该bug。</p>

<h2>参考</h2>

<p><a href="http://groups.google.com/group/comp.soft-sys.ace/browse_thread/thread/3575b21beae71683?pli=1">http://groups.google.com/group/comp.soft-sys.ace/browse_thread/thread/3575b21beae71683?pli=1</a>
<a href="http://groups.google.com/group/comp.soft-sys.ace/browse_thread/thread/38fb11cf258f3eec">http://groups.google.com/group/comp.soft-sys.ace/browse_thread/thread/38fb11cf258f3eec</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/02/06/setup-vnc-on-rhel/">RHEL下如何启用VNC服务</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-02-06T21:51:00-08:00" pubdate data-updated="true">Feb 6<span>th</span>, 2008</time>
        
         | <a href="/blog/2008/02/06/setup-vnc-on-rhel/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>编辑vnc服务的配置文件，设定哪些用户能启用VNC</p>

<pre><code>/etc/sysconfig/vncservers
</code></pre>

<p>比如允许mochen用户启动VNC服务</p>

<pre><code>VNCSERVERS="1:mochen"
VNCSERVERARGS[1]="-geometry 1024x768"
</code></pre>

<p>使用<code>su -</code>切换到VNC的用户下，修改该用户连接VNC时的密码，该密码可以与</p>

<p>系统的登录密码不一致：</p>

<pre><code>su - &lt;username&gt;
vncpasswd
</code></pre>

<p>启动VNC服务：</p>

<pre><code>service vncserver start
</code></pre>

<p>注：启动VNC服务前一定要先修改用户的VNC密码。</p>

<p>让VNC服务默认启动：</p>

<pre><code>chkconfig vncserver on
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/11/06/handle-signal-in-shell/">如何在shell脚本中捕获并处理信号</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-11-06T20:55:00-08:00" pubdate data-updated="true">Nov 6<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/11/06/handle-signal-in-shell/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>有时候在执行shell脚本的时候需要处理用户的中断，比如<code>Ctrl+C</code>，
收到这种中断后需要清理资源，然后优雅的退出程序。</p>

<p>那么如何在shell脚本中捕获并处理信号呢？简单的说就是使用<code>trap</code>命令。</p>

<p>一个简单的示例：</p>

<pre><code>LOCKFILE=/sc_agent/agent_keepalive.log

# redirect stdout and stderr to $LOGFILE
LOGFILE=/sc_agent/agent_keepalive.log
exec 1&gt;&gt;$LOGFILE
exec 2&gt;&gt;$LOGFILE

# show current date in log
date


# signal handler
exit_handler()
{
  echo "Enter exit_handler"
  rm -f $LOCKFILE
}

# install signal handler
trap exit_handler SIGINT SIGTERM SIGQUIT

if [ -f $LOCKFILE ] ; then
  kill -0 $(cat $LOCKFILE)
  if [ $? -eq 0 ]; then
    # The process is running
    exit 1;
  fi
fi

# write my pid to $LOCKFILE
echo $$ &gt; $LOCKFILE
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/10/18/linux-tasklist-lock-undefined-issue/">找不到 Tasklist_lock 的问题</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-10-18T20:50:00-07:00" pubdate data-updated="true">Oct 18<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/10/18/linux-tasklist-lock-undefined-issue/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在测试使用<code>for_each_process()</code>的时候需要获取<code>tasklist_lock</code>的读锁：</p>

<pre><code>read_lock(&amp;tasklist_lock);
</code></pre>

<p><code>tasklist_lock</code>声明在<code>include/linux/sched.h</code>里。
这样的代码可以编译，但是安装的模块的时候却遇到如下错误：</p>

<pre><code># insmod mymod.ko
insmod: error inserting 'mymod.ko': -1 Unknown symbol in module
</code></pre>

<p>查看<code>dmesg</code>信息得知其原因是找不到<code>tasklist_lock</code>这个符号：</p>

<pre><code># dmesg
mymod: Unknown symbol tasklist_lock
</code></pre>

<p>难道是<code>tasklist_lock</code>就没有被export了呢？
在网上搜索了一番，总算是找到根源，果真如此啊。
Kernel的变化就是快，又out一次。</p>

<blockquote><p>Index: linux-2.6/Documentation/feature-removal-schedule.txt<br/>===================================================================<br/>&#8212; linux-2.6.orig/Documentation/feature-removal-schedule.txt 2006-07-08 19:10:02.000000000 +0200<br/>+++ linux-2.6/Documentation/feature-removal-schedule.txt 2006-07-08 19:10:06.000000000 +0200<br/>@@ -166,17 +166,6 @@</p><p>&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;</p><p>-What: remove EXPORT_SYMBOL(tasklist_lock)<br/>-When: August 2006<br/>-Files: kernel/fork.c<br/>-Why: tasklist_lock protects the kernel internal task list. Modules have<br/>- no business looking at it, and all instances in drivers have been due<br/>- to use of too-lowlevel APIs. Having this symbol exported prevents<br/>- moving to more scalable locking schemes for the task list.<br/>-Who: Christoph Hellwig <hch@xxxxxx></p></blockquote>


<p>参考：</p>

<p><a href="http://lkml.indiana.edu/hypermail/linux/kernel/0607.1/0149.html">http://lkml.indiana.edu/hypermail/linux/kernel/0607.1/0149.html</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/10/15/linux-device-major-and-minor-number/">块设备和字符设备的区别及设备的major和minor号</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-10-15T22:35:00-07:00" pubdate data-updated="true">Oct 15<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/10/15/linux-device-major-and-minor-number/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>块(block)设备和字符(character)设备的区别：</h2>

<p><code>块设备</code>有缓冲，因此能选择响应请求的顺序以提高性能，读的时候是一块一块的读。
块设备能随机访问。存储设备一般是块设备。</p>

<p><code>字符设备</code>没有缓冲，按顺序读取。比如键盘，鼠标都是字符设备。
大多数设备都是字符设备，因为大多数设备都不需要块设备类型的缓冲。</p>

<p><code>ls -l /dev/</code>的结果以<code>b</code>开头就是块设备，以<code>c</code>开头的就是字符设备。</p>

<h2>设备的Major和Minor号</h2>

<p>先看看<code>ls -l /dev/hd*</code>的结果</p>

<pre><code># ls -l /dev/hd*
brw-r----- 1 root disk  3, 0 Nov 17 01:22 /dev/hda
brw-r----- 1 root disk  3, 1 Nov 17 01:23 /dev/hda1
brw-r----- 1 root disk  3, 2 Nov 17 01:22 /dev/hda2
brw-rw---- 1 root disk 22, 0 Nov 17 01:23 /dev/hdc
</code></pre>

<p>其中第四列的<code>3, 0</code>中的3即为<code>major</code>号，0即为<code>minor</code>号。
<code>major</code>号相同说明的使用的是相同的driver。每种driver都有自己唯一的<code>major</code>号。
<code>minor</code>号用于driver区别该driver控制的不同的硬件。</p>

<p><code>Documentation/devices.txt</code>是Linux的设备列表，列出了已经使用的<code>major</code>和<code>minor</code>号。</p>

<p>创建设备的方法是使用<code>mknod</code>命令：</p>

<pre><code># mknod /dev/ssa c 11 2
# ll -l /dev/ssa
crw-r--r-- 1 root root 11, 2 Nov 18 22:26 /dev/ssa
</code></pre>

<p>系统在安装的时候已经自动使用<code>mknod</code>把相关的设备文件创建好了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/09/17/understand-linux-oops/">解读Linux内核的Oops</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-09-17T21:35:00-07:00" pubdate data-updated="true">Sep 17<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/09/17/understand-linux-oops/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Oops是内核编程中比较容易遇到的问题，为了跟多的了解Oops来便于调试，我对Oops提供的信息进行一个总结，以及如何调试Oops。</p>

<p>一个完整的Oops：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>BUG: unable to handle kernel paging request at 00316b01
</span><span class='line'>IP: [&lt;c05dd045>] netif_receive_skb+0x335/0x377
</span><span class='line'>*pde = 00000000
</span><span class='line'>Thread overran stack, or stack corrupted
</span><span class='line'>Oops: 0000 [#1] SMP
</span><span class='line'>last sysfs file: /sys/block/hda/size
</span><span class='line'>Modules linked in: mymod ipv6 autofs4 nls_utf8 cifs lockd sunrpc dm_multipath
</span><span class='line'>scsi_dh video output sbs sbshc battery lp sg snd_ens1371 gameport ide_cd_mod
</span><span class='line'>snd_rawmidi cdrom snd_ac97_codec ac97_bus snd_seq_dummy snd_seq_oss
</span><span class='line'>snd_seq_midi_event snd_seq snd_seq_device snd_pcm_oss snd_mixer_oss
</span><span class='line'>parport_pc ac floppy serio_raw snd_pcm button parport rtc_cmos rtc_core
</span><span class='line'>rtc_lib snd_timer snd pcnet32 mii soundcore snd_page_alloc i2c_piix4 i2c_core
</span><span class='line'>pcspkr dm_snapshot dm_zero dm_mirror dm_region_hash dm_log dm_mod ata_piix
</span><span class='line'>libata mptspi mptscsih mptbase scsi_transport_spi sd_mod scsi_mod ext3 jbd
</span><span class='line'>uhci_hcd ohci_hcd ehci_hcd [last unloaded: mymod]
</span><span class='line'>
</span><span class='line'>Pid: 0, comm: swapper Not tainted (2.6.30.9 #1) VMware Virtual Platform
</span><span class='line'>EIP: 0060:[&lt;c05dd045>] EFLAGS: 00010206 CPU: 0
</span><span class='line'>EIP is at netif_receive_skb+0x335/0x377
</span><span class='line'>EAX: 00316ae1 EBX: deb7d600 ECX: 00316ae1 EDX: e2f357c0
</span><span class='line'>ESI: 00000008 EDI: de9a4800 EBP: c9403f40 ESP: c9403f10
</span><span class='line'> DS: 007b ES: 007b FS: 00d8 GS: 0000 SS: 0068
</span><span class='line'>Process swapper (pid: 0, ti=c9403000 task=c0737320 task.ti=c0779000)
</span><span class='line'>Stack:
</span><span class='line'> 00316ae1 c07777a0 e2f787c0 00000000 00000001 00000008 00000010 deb7d600
</span><span class='line'> c9403f40 deb7d600 00000000 df5acc58 c9403fb0 e0e61db0 00000000 00000010
</span><span class='line'> de9a4bb8 de9a4b40 de9a4800 00002000 00000001 00000000 1ea2c822 deb7d600
</span><span class='line'>Call Trace:
</span><span class='line'> [&lt;e0e61db0>] ? pcnet32_poll+0x347/0x66a [pcnet32]
</span><span class='line'> [&lt;c041f984>] ? run_rebalance_domains+0x13d/0x3ed
</span><span class='line'> [&lt;c05df364>] ? net_rx_action+0x6a/0xf4
</span><span class='line'> [&lt;c0429e2a>] ? __do_softirq+0x94/0x138
</span><span class='line'> [&lt;c0429d96>] ? __do_softirq+0x0/0x138
</span><span class='line'> &lt;IRQ> &lt;0> [&lt;c0429d94>] ? irq_exit+0x29/0x2b
</span><span class='line'> [&lt;c040423b>] ? do_IRQ+0x6d/0x83
</span><span class='line'> [&lt;c0402e89>] ? common_interrupt+0x29/0x30
</span><span class='line'> [&lt;c040828a>] ? default_idle+0x5b/0x92
</span><span class='line'> [&lt;c0401a92>] ? cpu_idle+0x3a/0x4e
</span><span class='line'> [&lt;c063d84b>] ? rest_init+0x53/0x55
</span><span class='line'> [&lt;c077f7df>] ? start_kernel+0x293/0x298
</span><span class='line'> [&lt;c077f06a>] ? i386_start_kernel+0x6a/0x6f
</span><span class='line'>Code: 74 14 f0 ff 83 a8 00 00 00 8b 4d d8 89 d8 8b 53 14 57 ff 51 08 58 8b 45
</span><span class='line'>d0 89 45 d8 8b 55 d0 8b 42 20 83 e8 20 89 45 d0 8b 4d d0 &lt;8b> 41 20 0f 18 00
</span><span class='line'>90 89 c8 83 c0 20 3b 45 d4 75 a4 83 7d d8 00
</span><span class='line'>EIP: [&lt;c05dd045>] netif_receive_skb+0x335/0x377 SS:ESP 0068:c9403f10
</span><span class='line'>CR2: 0000000000316b01
</span><span class='line'>---[ end trace 0330855ac41edfb5 ]---
</span><span class='line'>Kernel panic - not syncing: Fatal exception in interrupt
</span><span class='line'>Pid: 0, comm: swapper Tainted: G      D    2.6.30.9 #1
</span><span class='line'>Call Trace:
</span><span class='line'> [&lt;c0425ff3>] panic+0x3f/0xdf
</span><span class='line'> [&lt;c0405644>] oops_end+0x8c/0x9b
</span><span class='line'> [&lt;c041673a>] no_context+0x10c/0x116
</span><span class='line'> [&lt;c04168c7>] __bad_area_nosemaphore+0xe0/0xe8
</span><span class='line'> [&lt;c0416933>] bad_area_nosemaphore+0xd/0x10
</span><span class='line'> [&lt;c0416aa7>] do_page_fault+0xde/0x1e3
</span><span class='line'> [&lt;c04169c9>] ? do_page_fault+0x0/0x1e3
</span><span class='line'> [&lt;c064f38d>] error_code+0x6d/0x74
</span><span class='line'> [&lt;c061007b>] ? tcp_v4_rcv+0x55b/0x600
</span><span class='line'> [&lt;c04169c9>] ? do_page_fault+0x0/0x1e3
</span><span class='line'> [&lt;c05dd045>] ? netif_receive_skb+0x335/0x377
</span><span class='line'> [&lt;e0e61db0>] pcnet32_poll+0x347/0x66a [pcnet32]
</span><span class='line'> [&lt;c041f984>] ? run_rebalance_domains+0x13d/0x3ed
</span><span class='line'> [&lt;c05df364>] net_rx_action+0x6a/0xf4
</span><span class='line'> [&lt;c0429e2a>] __do_softirq+0x94/0x138
</span><span class='line'> [&lt;c0429d96>] ? __do_softirq+0x0/0x138
</span><span class='line'> &lt;IRQ>  [&lt;c0429d94>] ? irq_exit+0x29/0x2b
</span><span class='line'> [&lt;c040423b>] ? do_IRQ+0x6d/0x83
</span><span class='line'> [&lt;c0402e89>] ? common_interrupt+0x29/0x30
</span><span class='line'> [&lt;c040828a>] ? default_idle+0x5b/0x92
</span><span class='line'> [&lt;c0401a92>] ? cpu_idle+0x3a/0x4e
</span><span class='line'> [&lt;c063d84b>] ? rest_init+0x53/0x55
</span><span class='line'> [&lt;c077f7df>] ? start_kernel+0x293/0x298
</span><span class='line'> [&lt;c077f06a>] ? i386_start_kernel+0x6a/0x6f</span></code></pre></td></tr></table></div></figure>


<p>解析Oops的具体含义：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>BUG: unable to handle kernel paging request at 00316b01
</span><span class='line'>IP: [&lt;c05dd045>] netif_receive_skb+0x335/0x377
</span><span class='line'>*pde = 00000000
</span><span class='line'>Thread overran stack, or stack corrupted
</span><span class='line'>Oops: 0000 [#1] SMP
</span><span class='line'>last sysfs file: /sys/block/hda/size
</span><span class='line'>Modules linked in: mymod ipv6 autofs4 nls_utf8 cifs lockd sunrpc dm_multipath
</span><span class='line'>scsi_dh video output sbs sbshc battery lp sg snd_ens1371 gameport ide_cd_mod
</span><span class='line'>snd_rawmidi cdrom snd_ac97_codec ac97_bus snd_seq_dummy snd_seq_oss
</span><span class='line'>snd_seq_midi_event snd_seq snd_seq_device snd_pcm_oss snd_mixer_oss
</span><span class='line'>parport_pc ac floppy serio_raw snd_pcm button parport rtc_cmos rtc_core
</span><span class='line'>rtc_lib snd_timer snd pcnet32 mii soundcore snd_page_alloc i2c_piix4 i2c_core
</span><span class='line'>pcspkr dm_snapshot dm_zero dm_mirror dm_region_hash dm_log dm_mod ata_piix
</span><span class='line'>libata mptspi mptscsih mptbase scsi_transport_spi sd_mod scsi_mod ext3 jbd
</span><span class='line'>uhci_hcd ohci_hcd ehci_hcd [last unloaded: mymod]</span></code></pre></td></tr></table></div></figure>


<p>上面这段这个是载入的模块信息。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Pid: 0, comm: swapper Not tainted (2.6.30.9 #1) VMware Virtual Platform
</span><span class='line'>EIP: 0060:[&lt;c05dd045>] EFLAGS: 00010206 CPU: 0
</span><span class='line'>EIP is at netif_receive_skb+0x335/0x377</span></code></pre></td></tr></table></div></figure>


<p><code>EIP</code>这行指明发生Oops的具体位置，我们可以通过这个来找到出现Oops的源代码的具体行。
具体方法如下：</p>

<p>通过使用<code>objdump -S</code>反汇编<code>netif_receice_skb</code>所在的目标文件，
然后找到偏移量为0x355的行，看看这行是有什么代码汇编来的，再结合寄存器的值就能分析这个Oops的原因了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EAX: 00316ae1 EBX: deb7d600 ECX: 00316ae1 EDX: e2f357c0
</span><span class='line'>ESI: 00000008 EDI: de9a4800 EBP: c9403f40 ESP: c9403f10
</span><span class='line'> DS: 007b ES: 007b FS: 00d8 GS: 0000 SS: 0068
</span><span class='line'>Process swapper (pid: 0, ti=c9403000 task=c0737320 task.ti=c0779000)
</span><span class='line'>Stack:
</span><span class='line'> 00316ae1 c07777a0 e2f787c0 00000000 00000001 00000008 00000010 deb7d600
</span><span class='line'> c9403f40 deb7d600 00000000 df5acc58 c9403fb0 e0e61db0 00000000 00000010
</span><span class='line'> de9a4bb8 de9a4b40 de9a4800 00002000 00000001 00000000 1ea2c822 deb7d600</span></code></pre></td></tr></table></div></figure>


<p>上面这段是寄存器和栈的信息。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Call Trace:
</span><span class='line'> [&lt;e0e61db0>] ? pcnet32_poll+0x347/0x66a [pcnet32]
</span><span class='line'> [&lt;c041f984>] ? run_rebalance_domains+0x13d/0x3ed
</span><span class='line'> [&lt;c05df364>] ? net_rx_action+0x6a/0xf4
</span><span class='line'> [&lt;c0429e2a>] ? __do_softirq+0x94/0x138
</span><span class='line'> [&lt;c0429d96>] ? __do_softirq+0x0/0x138
</span><span class='line'> &lt;IRQ> &lt;0> [&lt;c0429d94>] ? irq_exit+0x29/0x2b
</span><span class='line'> [&lt;c040423b>] ? do_IRQ+0x6d/0x83
</span><span class='line'> [&lt;c0402e89>] ? common_interrupt+0x29/0x30
</span><span class='line'> [&lt;c040828a>] ? default_idle+0x5b/0x92
</span><span class='line'> [&lt;c0401a92>] ? cpu_idle+0x3a/0x4e
</span><span class='line'> [&lt;c063d84b>] ? rest_init+0x53/0x55
</span><span class='line'> [&lt;c077f7df>] ? start_kernel+0x293/0x298
</span><span class='line'> [&lt;c077f06a>] ? i386_start_kernel+0x6a/0x6f</span></code></pre></td></tr></table></div></figure>


<p>发生Oops的内核栈信息。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Code: 74 14 f0 ff 83 a8 00 00 00 8b 4d d8 89 d8 8b 53 14 57 ff 51 08 58 8b 45
</span><span class='line'>d0 89 45 d8 8b 55 d0 8b 42 20 83 e8 20 89 45 d0 8b 4d d0 &lt;8b> 41 20 0f 18 00
</span><span class='line'>90 89 c8 83 c0 20 3b 45 d4 75 a4 83 7d d8 00
</span><span class='line'>EIP: [&lt;c05dd045>] netif_receive_skb+0x335/0x377 SS:ESP 0068:c9403f10
</span><span class='line'>CR2: 0000000000316b01
</span><span class='line'>---[ end trace 0330855ac41edfb5 ]---
</span><span class='line'>Kernel panic - not syncing: Fatal exception in interrupt
</span><span class='line'>Pid: 0, comm: swapper Tainted: G      D    2.6.30.9 #1</span></code></pre></td></tr></table></div></figure>


<p>如果kernel报告<code>Tainted</code>，说明kernel被损坏了，在“Trainted：”后面最多会有10个字符的提示信息来表示具体的信息。每一位上使用一个字母来表示，如下：</p>

<p>1: &#8216;G&#8217;: 所有的模块都是GPL的License。如果有模块缺少MODULE_LICENSE()或者声明是Proprietary的，则为&#8217;P&#8217;。</p>

<p>2: &#8216;F&#8217;: 如果有模块是使用 insmod -f 强制载入的。否则为空。</p>

<p>3: &#8216;S&#8217;: 如果Oops发生在SMP的CPU上，但这个型号的CPU还没有被认为是SMP安全的。</p>

<p>4: &#8216;R&#8217;: 如果有模块是使用 rmmod -f 强制卸载的。否则为空。</p>

<p>5: &#8216;M&#8217;: 有CPU报告了Machine Check Exception，否则为空。</p>

<p>6: &#8216;B&#8217;: 如果有page-release函数发现一个错误的page或未知的page标志。</p>

<p>7: &#8216;U&#8217;: 来自用户空间的程序设置的这个标志位。</p>

<p>8: &#8216;D&#8217;: 内核刚刚死掉，比如Oops或者是bug。</p>

<p>9: &#8216;A&#8217;: ACPI表被覆盖。</p>

<p>10: &#8216;W&#8217;: 之前kernel已经产生过警告。</p>

<p>Tainted字符串主要的目的是告诉调试器这个kernel已经不是一个干净的kernel了。如果一个模块在加载了之后又卸载了，Tainted仍然会保持。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Call Trace:
</span><span class='line'> [&lt;c0425ff3>] panic+0x3f/0xdf
</span><span class='line'> [&lt;c0405644>] oops_end+0x8c/0x9b
</span><span class='line'> [&lt;c041673a>] no_context+0x10c/0x116
</span><span class='line'> [&lt;c04168c7>] __bad_area_nosemaphore+0xe0/0xe8
</span><span class='line'> [&lt;c0416933>] bad_area_nosemaphore+0xd/0x10
</span><span class='line'> [&lt;c0416aa7>] do_page_fault+0xde/0x1e3
</span><span class='line'> [&lt;c04169c9>] ? do_page_fault+0x0/0x1e3
</span><span class='line'> [&lt;c064f38d>] error_code+0x6d/0x74
</span><span class='line'> [&lt;c061007b>] ? tcp_v4_rcv+0x55b/0x600
</span><span class='line'> [&lt;c04169c9>] ? do_page_fault+0x0/0x1e3
</span><span class='line'> [&lt;c05dd045>] ? netif_receive_skb+0x335/0x377
</span><span class='line'> [&lt;e0e61db0>] pcnet32_poll+0x347/0x66a [pcnet32]
</span><span class='line'> [&lt;c041f984>] ? run_rebalance_domains+0x13d/0x3ed
</span><span class='line'> [&lt;c05df364>] net_rx_action+0x6a/0xf4
</span><span class='line'> [&lt;c0429e2a>] __do_softirq+0x94/0x138
</span><span class='line'> [&lt;c0429d96>] ? __do_softirq+0x0/0x138
</span><span class='line'> &lt;IRQ>  [&lt;c0429d94>] ? irq_exit+0x29/0x2b
</span><span class='line'> [&lt;c040423b>] ? do_IRQ+0x6d/0x83
</span><span class='line'> [&lt;c0402e89>] ? common_interrupt+0x29/0x30
</span><span class='line'> [&lt;c040828a>] ? default_idle+0x5b/0x92
</span><span class='line'> [&lt;c0401a92>] ? cpu_idle+0x3a/0x4e
</span><span class='line'> [&lt;c063d84b>] ? rest_init+0x53/0x55
</span><span class='line'> [&lt;c077f7df>] ? start_kernel+0x293/0x298
</span><span class='line'> [&lt;c077f06a>] ? i386_start_kernel+0x6a/0x6f</span></code></pre></td></tr></table></div></figure>


<p>最后发现一篇调试Oops的专题：
<a href="http://mail.nl.linux.org/kernelnewbies/2003-08/msg00347.html">paper on debugging kernel oops or hang</a>
。
虽然是针对2.4的，但还是值得一读。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/09/14/compile-centos-5-kernel/">编译CentOS 5的内核</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-09-14T22:52:00-07:00" pubdate data-updated="true">Sep 14<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/09/14/compile-centos-5-kernel/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这段时间因为需要接触Linux内核，CentOS/RHEL的内核源代码缺省安装时并不会安装，
需要单独的安装。</p>

<p><code>CentOS 5</code>提供了自己的内核编译方法，详见 <a href="http://wiki.centos.org/HowTos/Custom_Kernel">http://wiki.centos.org/HowTos/Custom_Kernel</a>。
但这只能编译CentOS 5的主流内核版本2.6.18，
如果要编译其它版本的内核还是需要从<a href="http://www.kernel.org">http://www.kernel.org</a>下载后进行编译。</p>

<p>第一步，获取内核源代码</p>

<pre><code>$ mkdir linux
$ cd linux
$ wget http://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.30.9.tar.bz2
$ bzip2 -dc linux-2.6.30.9.tar.bz2 | tar xvf -
</code></pre>

<p>第二步，配置和编译内核</p>

<pre><code>$ cd linux-2.6.30.9
$ make config       # 创建一个缺省的配置文件
$ make menuconfig   # 基于刚才创建的配置文件修改配置，在这一步可以定制内核
$ make -j2
</code></pre>

<p>第三步，安装新的内核（需要root的身份）</p>

<p>安装 mkinitrd 来获取 installkernel 这个脚本：</p>

<pre><code># yum install mkinitrd
</code></pre>

<p>安装内核模块：</p>

<pre><code># make modules_install
</code></pre>

<p>安装目标目录为<code>/lib/modules/kernel-version/</code>。
<code>kernel-version</code>为要安装的内核版本，可以使用如下命令查看：</p>

<pre><code># make kernelversion
</code></pre>

<p>如果这个目录不存在，它会自动创建。</p>

<p>安装内核：</p>

<pre><code># make install
</code></pre>

<p>它会自动添加新内核到Grub（Lilo也支持，不过估计现在用Lilo的人应该越来越少了）的引导菜单中的。</p>

<p>然后重新启动就可以再Grub中选择新的内核进行启动了。</p>

<p>参考</p>

<ul>
<li><a href="http://www.kroah.com/lkn/">Linux Kernel in a Nutshell</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/08/15/use-vmware-debug-linux-oops/">使用VMware捕获Linux的串口输出来调试内核的Oops</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-08-15T20:19:00-07:00" pubdate data-updated="true">Aug 15<span>th</span>, 2007</time>
        
         | <a href="/blog/2007/08/15/use-vmware-debug-linux-oops/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Linux的Kernel在产生Oops后会默认情况下把Oops的相关信息打印在控制台上，只有通过控制台才能看到Oops的信息，而且因为受到控制台行数限制，不能完整的看到Oops的信息，这样对调试Oops很麻烦，一种方法是使用虚拟机，把串口输出指定到文件，然后再的Linux的控制台消息重定向到串口，这样可以很方便的捕获串口输出，方便调试Oops。</p>

<p>第一步，在VMware中设置串口输出：</p>

<pre><code>Settings -&gt; Hardware -&gt; Add... 添加一个新的串口设备，指定使用文件输出。
</code></pre>

<p>第二步，在Linux中对串口进行重定向。修改 /etc/grub.conf 的kernel 行，在行尾加入如下参数：</p>

<pre><code>console=ttyS0,115200 console=tty0
</code></pre>

<p>重启，然后测试一下产生一个Oops，看看串口文件，如下，已经有完整的Oops的信息了：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sd 0:0:0:0: [sda] Assuming drive cache: write through
</span><span class='line'>sd 0:0:0:0: [sda] Assuming drive cache: write through
</span><span class='line'>BUG: unable to handle kernel paging request at 00316b01
</span><span class='line'>IP: [&lt;c05dd045>] netif_receive_skb+0x335/0x377
</span><span class='line'>*pde = 00000000
</span><span class='line'>Thread overran stack, or stack corrupted
</span><span class='line'>Oops: 0000 [#1] SMP
</span><span class='line'>last sysfs file: /sys/block/hda/size
</span><span class='line'>Modules linked in: mymod ipv6 autofs4 nls_utf8 cifs lockd
</span><span class='line'>sunrpc dm_multipath scsi_dh video output sbs sbshc battery
</span><span class='line'>lp sg snd_ens1371 gameport ide_cd_mod snd_rawmidi cdrom snd_ac97_codec ac97_bus snd_seq_dummy snd_seq_oss
</span><span class='line'>snd_seq_midi_event snd_seq snd_seq_device snd_pcm_oss
</span><span class='line'>snd_mixer_oss parport_pc ac floppy serio_raw snd_pcm
</span><span class='line'>button parport rtc_cmos rtc_core rtc_lib snd_timer snd
</span><span class='line'>pcnet32 mii soundcore snd_page_alloc i2c_piix4 i2c_core
</span><span class='line'>pcspkr dm_snapshot dm_zero dm_mirror dm_region_hash
</span><span class='line'>dm_log dm_mod ata_piix libata mptspi mptscsih mptbase
</span><span class='line'>scsi_transport_spi sd_mod scsi_mod ext3 jbd uhci_hcd
</span><span class='line'>ohci_hcd ehci_hcd [last unloaded: mymod]
</span><span class='line'>
</span><span class='line'>Pid: 0, comm: swapper Not tainted (2.6.30.9 #1) VMware Virtual Platform
</span><span class='line'>EIP: 0060:[&lt;c05dd045>] EFLAGS: 00010206 CPU: 0
</span><span class='line'>EIP is at netif_receive_skb+0x335/0x377
</span><span class='line'>EAX: 00316ae1 EBX: deb7d600 ECX: 00316ae1 EDX: e2f357c0
</span><span class='line'>ESI: 00000008 EDI: de9a4800 EBP: c9403f40 ESP: c9403f10
</span><span class='line'> DS: 007b ES: 007b FS: 00d8 GS: 0000 SS: 0068
</span><span class='line'>Process swapper (pid: 0, ti=c9403000 task=c0737320 task.ti=c0779000)
</span><span class='line'>Stack:
</span><span class='line'> 00316ae1 c07777a0 e2f787c0 00000000 00000001 00000008 00000010 deb7d600
</span><span class='line'> c9403f40 deb7d600 00000000 df5acc58 c9403fb0 e0e61db0 00000000 00000010
</span><span class='line'> de9a4bb8 de9a4b40 de9a4800 00002000 00000001 00000000 1ea2c822 deb7d600
</span><span class='line'>Call Trace:
</span><span class='line'> [&lt;e0e61db0>] ? pcnet32_poll+0x347/0x66a [pcnet32]
</span><span class='line'> [&lt;c041f984>] ? run_rebalance_domains+0x13d/0x3ed
</span><span class='line'> [&lt;c05df364>] ? net_rx_action+0x6a/0xf4
</span><span class='line'> [&lt;c0429e2a>] ? __do_softirq+0x94/0x138
</span><span class='line'> [&lt;c0429d96>] ? __do_softirq+0x0/0x138
</span><span class='line'> &lt;IRQ> &lt;0> [&lt;c0429d94>] ? irq_exit+0x29/0x2b
</span><span class='line'> [&lt;c040423b>] ? do_IRQ+0x6d/0x83
</span><span class='line'> [&lt;c0402e89>] ? common_interrupt+0x29/0x30
</span><span class='line'> [&lt;c040828a>] ? default_idle+0x5b/0x92
</span><span class='line'> [&lt;c0401a92>] ? cpu_idle+0x3a/0x4e
</span><span class='line'> [&lt;c063d84b>] ? rest_init+0x53/0x55
</span><span class='line'> [&lt;c077f7df>] ? start_kernel+0x293/0x298
</span><span class='line'> [&lt;c077f06a>] ? i386_start_kernel+0x6a/0x6f
</span><span class='line'>Code: 74 14 f0 ff 83 a8 00 00 00 8b 4d d8 89 d8 8b 53 14 57 ff
</span><span class='line'>51 08 58 8b 45 d0 89 45 d8 8b 55 d0 8b 42 20 83 e8 20 89 45 d0
</span><span class='line'>8b 4d d0 &lt;8b> 41 20 0f 18 00 90 89 c8 83 c0 20 3b 45 d4 75 a4
</span><span class='line'>83 7d d8 00
</span><span class='line'>EIP: [&lt;c05dd045>] netif_receive_skb+0x335/0x377 SS:ESP 0068:c9403f10
</span><span class='line'>CR2: 0000000000316b01
</span><span class='line'>---[ end trace 0330855ac41edfb5 ]---
</span><span class='line'>Kernel panic - not syncing: Fatal exception in interrupt
</span><span class='line'>Pid: 0, comm: swapper Tainted: G      D    2.6.30.9 #1
</span><span class='line'>Call Trace:
</span><span class='line'> [&lt;c0425ff3>] panic+0x3f/0xdf
</span><span class='line'> [&lt;c0405644>] oops_end+0x8c/0x9b
</span><span class='line'> [&lt;c041673a>] no_context+0x10c/0x116
</span><span class='line'> [&lt;c04168c7>] __bad_area_nosemaphore+0xe0/0xe8
</span><span class='line'> [&lt;c0416933>] bad_area_nosemaphore+0xd/0x10
</span><span class='line'> [&lt;c0416aa7>] do_page_fault+0xde/0x1e3
</span><span class='line'> [&lt;c04169c9>] ? do_page_fault+0x0/0x1e3
</span><span class='line'> [&lt;c064f38d>] error_code+0x6d/0x74
</span><span class='line'> [&lt;c061007b>] ? tcp_v4_rcv+0x55b/0x600
</span><span class='line'> [&lt;c04169c9>] ? do_page_fault+0x0/0x1e3
</span><span class='line'> [&lt;c05dd045>] ? netif_receive_skb+0x335/0x377
</span><span class='line'> [&lt;e0e61db0>] pcnet32_poll+0x347/0x66a [pcnet32]
</span><span class='line'> [&lt;c041f984>] ? run_rebalance_domains+0x13d/0x3ed
</span><span class='line'> [&lt;c05df364>] net_rx_action+0x6a/0xf4
</span><span class='line'> [&lt;c0429e2a>] __do_softirq+0x94/0x138
</span><span class='line'> [&lt;c0429d96>] ? __do_softirq+0x0/0x138
</span><span class='line'> &lt;IRQ>  [&lt;c0429d94>] ? irq_exit+0x29/0x2b
</span><span class='line'> [&lt;c040423b>] ? do_IRQ+0x6d/0x83
</span><span class='line'> [&lt;c0402e89>] ? common_interrupt+0x29/0x30
</span><span class='line'> [&lt;c040828a>] ? default_idle+0x5b/0x92
</span><span class='line'> [&lt;c0401a92>] ? cpu_idle+0x3a/0x4e
</span><span class='line'> [&lt;c063d84b>] ? rest_init+0x53/0x55
</span><span class='line'> [&lt;c077f7df>] ? start_kernel+0x293/0x298
</span><span class='line'> [&lt;c077f06a>] ? i386_start_kernel+0x6a/0x6f</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/04/10/openssl-heartbleed-impact-on-android/">OpenSSL Heartbleed漏洞对Android的影响</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/02/android-hack-tools/">Android APK解析及反编译</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/02/using-sphinx-to-generate-chinese-pdf/">在Mac上使用Sphinx产生文档并生成中文PDF文档</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/04/android-library-jar/">Android的Library工程</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/12/centos-tips/">CentOS Tips</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/18/android-hardware-accel/">Android的硬件加速及可能导致的问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/25/python-tips/">Python Tips</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/21/protobuf-ios/">在iOS上使用protobuf</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/15/learn-octave/">学习一点octave</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/08/python-pip-virtualenv/">Python的virtualenv和pip</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/ace' style='font-size: 108.57142857142857%'>ace(2)</a> <a href='/blog/categories/agile' style='font-size: 104.28571428571429%'>agile(1)</a> <a href='/blog/categories/ai' style='font-size: 104.28571428571429%'>ai(1)</a> <a href='/blog/categories/algorithm' style='font-size: 112.85714285714286%'>algorithm(3)</a> <a href='/blog/categories/android' style='font-size: 121.42857142857143%'>android(5)</a> <a href='/blog/categories/apt' style='font-size: 104.28571428571429%'>apt(1)</a> <a href='/blog/categories/centos' style='font-size: 104.28571428571429%'>centos(1)</a> <a href='/blog/categories/debian' style='font-size: 104.28571428571429%'>debian(1)</a> <a href='/blog/categories/debug' style='font-size: 117.14285714285714%'>debug(4)</a> <a href='/blog/categories/django' style='font-size: 108.57142857142857%'>django(2)</a> <a href='/blog/categories/drbd' style='font-size: 104.28571428571429%'>drbd(1)</a> <a href='/blog/categories/gdb' style='font-size: 104.28571428571429%'>gdb(1)</a> <a href='/blog/categories/git' style='font-size: 104.28571428571429%'>git(1)</a> <a href='/blog/categories/howto' style='font-size: 112.85714285714286%'>howto(3)</a> <a href='/blog/categories/hp-ux' style='font-size: 104.28571428571429%'>hp-ux(1)</a> <a href='/blog/categories/html5' style='font-size: 104.28571428571429%'>html5(1)</a> <a href='/blog/categories/http' style='font-size: 104.28571428571429%'>http(1)</a> <a href='/blog/categories/ios' style='font-size: 104.28571428571429%'>ios(1)</a> <a href='/blog/categories/javascript' style='font-size: 112.85714285714286%'>javascript(3)</a> <a href='/blog/categories/jquery' style='font-size: 108.57142857142857%'>jquery(2)</a> <a href='/blog/categories/kernel' style='font-size: 125.71428571428572%'>kernel(6)</a> <a href='/blog/categories/linux' style='font-size: 160.0%'>linux(14)</a> <a href='/blog/categories/linux' style='font-size: 104.28571428571429%'>Linux(1)</a> <a href='/blog/categories/nettl' style='font-size: 104.28571428571429%'>nettl(1)</a> <a href='/blog/categories/ntp' style='font-size: 104.28571428571429%'>ntp(1)</a> <a href='/blog/categories/octave' style='font-size: 108.57142857142857%'>octave(2)</a> <a href='/blog/categories/openssl' style='font-size: 104.28571428571429%'>openssl(1)</a> <a href='/blog/categories/pip' style='font-size: 104.28571428571429%'>pip(1)</a> <a href='/blog/categories/protobuf' style='font-size: 104.28571428571429%'>protobuf(1)</a> <a href='/blog/categories/putty' style='font-size: 104.28571428571429%'>putty(1)</a> <a href='/blog/categories/python' style='font-size: 117.14285714285714%'>python(4)</a> <a href='/blog/categories/scrum' style='font-size: 104.28571428571429%'>scrum(1)</a> <a href='/blog/categories/secure' style='font-size: 104.28571428571429%'>secure(1)</a> <a href='/blog/categories/security' style='font-size: 104.28571428571429%'>security(1)</a> <a href='/blog/categories/shell' style='font-size: 104.28571428571429%'>shell(1)</a> <a href='/blog/categories/sphinx' style='font-size: 104.28571428571429%'>sphinx(1)</a> <a href='/blog/categories/tips' style='font-size: 104.28571428571429%'>tips(1)</a> <a href='/blog/categories/virtualenv' style='font-size: 104.28571428571429%'>virtualenv(1)</a> <a href='/blog/categories/web' style='font-size: 108.57142857142857%'>web(2)</a> <a href='/blog/categories/windbg' style='font-size: 104.28571428571429%'>windbg(1)</a> <a href='/blog/categories/wp7' style='font-size: 112.85714285714286%'>wp7(3)</a> </span>
</section>

<section>
  <h1>新浪微博</h1>
  <ul id="weibo">
    <li>
      <iframe 
        width="100%" 
        height="550" 
        class="share_self" 
        frameborder="0" 
        scrolling="no" 
        src="http://widget.weibo.com/weiboshow/index.php?width=0&height=550&ptype=1&speed=0&skin=&isTitle=0&noborder=1&isWeibo=1&isFans=&uid=2036163762&verifier=bce5fd03">
      </iframe>
    </li>
  </ul>
</section>







  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Ming -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'chenming';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
